<!doctype html>
<html lang="th" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Report Management System</title>

  <!-- <script src="/_sdk/data_sdk.js"></script> -->
  <!-- <script src="/_sdk/element_sdk.js"></script> -->

  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <!-- ‚úÖ NEW: XLSX Export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">

  <style>
    body { box-sizing: border-box; font-family: 'Kanit', sans-serif; }
    * { font-family: 'Kanit', sans-serif; }

    .glass-card {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .glass-card-solid {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .gradient-bg {
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 25%, #3d7ab5 50%, #5a9fd4 75%, #87ceeb 100%);
    }
    .stat-card { transition: all 0.3s ease; }
    .stat-card:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(0,0,0,0.2); }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      transition: all 0.3s ease;
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
    }
    .btn-secondary {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      transition: all 0.3s ease;
    }
    .btn-secondary:hover {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
    }
    .btn-warning {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      transition: all 0.3s ease;
    }
    .btn-warning:hover { background: linear-gradient(135deg, #d97706 0%, #b45309 100%); }

    .table-row { transition: all 0.2s ease; }
    .table-row:hover { background: rgba(59, 130, 246, 0.05); }

    .modal-overlay { background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }

    .toast { animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

    .spinner {
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    select, input, textarea { font-family: 'Kanit', sans-serif; }

    .highlight-duplicate { animation: highlightPulse 2s ease; }
    @keyframes highlightPulse {
      0%, 100% { background: rgba(239, 68, 68, 0.1); }
      50% { background: rgba(239, 68, 68, 0.3); }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
</head>

<body class="h-full gradient-bg">
  <div id="app" class="h-full overflow-auto">
    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Main Dashboard -->
    <div id="dashboard-page" class="min-h-full p-4 md:p-6 lg:p-8">
      <!-- Header -->
      <header class="glass-card rounded-2xl p-6 mb-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <h1 id="dashboard-title" class="text-2xl md:text-3xl font-bold text-white">üö¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ù‡∏∂‡∏Å‡∏á‡∏≤‡∏ô</h1>
            <p class="text-blue-100 mt-1">Teacher Dashboard - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</p>
          </div>

          <div class="flex flex-wrap gap-3">
            <button onclick="openAddModal()" class="btn-primary text-white px-6 py-3 rounded-xl font-medium flex items-center gap-2 shadow-lg">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
              ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤
            </button>

            <button onclick="openStudentModal()" class="btn-secondary text-white px-6 py-3 rounded-xl font-medium flex items-center gap-2 shadow-lg">
              üë§ ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤
            </button>

            <button onclick="openSummaryModal()" class="btn-secondary text-white px-6 py-3 rounded-xl font-medium flex items-center gap-2 shadow-lg">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>

            <!-- ‚úÖ NEW: Export -->
            <button onclick="openExportModal()" class="btn-warning text-white px-6 py-3 rounded-xl font-medium flex items-center gap-2 shadow-lg">
              ‚¨áÔ∏è Export (CSV/Excel)
            </button>
          </div>
        </div>
      </header>

      <!-- Stats Cards -->
      <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
        <div class="stat-card glass-card rounded-2xl p-5">
          <div class="flex items-center gap-4">
            <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center">
              <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
            </div>
            <div>
              <p class="text-blue-100 text-sm">‡∏¢‡∏≠‡∏î‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</p>
              <p id="stat-total" class="text-3xl font-bold text-white">0</p>
            </div>
          </div>
        </div>

        <div class="stat-card glass-card rounded-2xl p-5">
          <div class="flex items-center gap-4">
            <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-teal-400 to-teal-600 flex items-center justify-center">
              <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
              </svg>
            </div>
            <div>
              <p class="text-blue-100 text-sm">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥)</p>
              <p id="stat-students" class="text-3xl font-bold text-white">0</p>
            </div>
          </div>
        </div>

        <div class="stat-card glass-card rounded-2xl p-5">
          <div class="flex items-center gap-4">
            <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-yellow-400 to-orange-500 flex items-center justify-center">
              <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div>
              <p class="text-blue-100 text-sm">STANDBYFORSHIP</p>
              <p id="stat-standby" class="text-3xl font-bold text-white">0</p>
            </div>
          </div>
        </div>

        <div class="stat-card glass-card rounded-2xl p-5">
          <div class="flex items-center gap-4">
            <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-green-400 to-emerald-600 flex items-center justify-center">
              <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div>
              <p class="text-blue-100 text-sm">ON BOARD</p>
              <p id="stat-onboard" class="text-3xl font-bold text-white">0</p>
            </div>
          </div>
        </div>

        <div class="stat-card glass-card rounded-2xl p-5">
          <div class="flex items-center gap-4">
            <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-purple-400 to-purple-600 flex items-center justify-center">
              <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
            </div>
            <div>
              <p class="text-blue-100 text-sm">ON LEAVE (TOTAL)</p>
              <p id="stat-onleave" class="text-3xl font-bold text-white">0</p>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚úÖ NEW: Dashboard Insights -->
      <div class="glass-card-solid rounded-2xl shadow-xl overflow-hidden mb-6">
        <div class="p-4 border-b border-gray-200 bg-gradient-to-r from-indigo-50 to-blue-50 flex flex-wrap items-center justify-between gap-2">
          <h2 class="text-lg font-semibold text-gray-800">üìà Dashboard Insights</h2>
          <div class="text-xs text-gray-500">
            ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="insights-updated">-</span>
            <span class="text-gray-300 mx-2">|</span>
            ‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á/‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
          </div>
        </div>

        <div class="p-6 grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div class="bg-white rounded-xl border border-gray-200 p-4">
            <h3 class="text-sm font-semibold text-gray-800 mb-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô %)</h3>
            <div id="insights-status" class="space-y-2"></div>
          </div>

          <div class="bg-white rounded-xl border border-gray-200 p-4">
            <h3 class="text-sm font-semibold text-gray-800 mb-3">‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏£‡∏¥‡∏õ)</h3>
            <div id="insights-year" class="space-y-2"></div>
          </div>

          <div class="bg-white rounded-xl border border-gray-200 p-4">
            <h3 class="text-sm font-semibold text-gray-800 mb-3">Top ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏£‡∏¥‡∏õ)</h3>
            <div id="insights-company" class="space-y-2"></div>
          </div>
        </div>
      </div>

      <!-- Filter & Table -->
      <div class="glass-card-solid rounded-2xl shadow-xl overflow-hidden">
        <!-- Filter Bar -->
        <div class="p-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50">
          <div class="flex flex-wrap items-center gap-4">
            <label class="text-gray-700 font-medium">‡∏Å‡∏£‡∏≠‡∏á‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤:</label>
            <select id="filter-year" onchange="renderTable()"
              class="px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
              <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
              <option value="2560">2560</option>
              <option value="2561">2561</option>
              <option value="2562">2562</option>
              <option value="2563">2563</option>
              <option value="2564">2564</option>
              <option value="2565">2565</option>
              <option value="2566">2566</option>
              <option value="2567">2567</option>
              <option value="2568">2568</option>
              <option value="2569">2569</option>
              <option value="2570">2570</option>
              <option value="2571">2571</option>
              <option value="2572">2572</option>
              <option value="2573">2573</option>
              <option value="2574">2574</option>
              <option value="2575">2575</option>
              <option value="2576">2576</option>
              <option value="2577">2577</option>
              <option value="2578">2578</option>
              <option value="2579">2579</option>
              <option value="2580">2580</option>
            </select>

            <label class="text-gray-700 font-medium ml-4">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:</label>
            <input type="text" id="search-input" onkeyup="renderTable()" placeholder="‡∏£‡∏´‡∏±‡∏™, ‡∏ä‡∏∑‡πà‡∏≠, ‡πÄ‡∏£‡∏∑‡∏≠..."
              class="px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">

            <span id="filter-count" class="text-gray-500 text-sm ml-auto"></span>
          </div>
        </div>

        <!-- Table -->
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white">
              <tr>
                <th class="px-4 py-4 text-left text-sm font-semibold">‡∏£‡∏´‡∏±‡∏™</th>
                <th class="px-4 py-4 text-left text-sm font-semibold">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                <th class="px-4 py-4 text-left text-sm font-semibold">Trip #</th>
                <th class="px-4 py-4 text-left text-sm font-semibold">‡∏•‡∏á‡∏•‡∏≥‡∏ó‡∏µ‡πà</th>
                <th class="px-4 py-4 text-left text-sm font-semibold">‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</th>
                <th class="px-4 py-4 text-left text-sm font-semibold">‡∏™‡∏≤‡∏Ç‡∏≤</th>
                <th class="px-4 py-4 text-left text-sm font-semibold">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</th>
                <th class="px-4 py-4 text-left text-sm font-semibold">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡∏≠</th>
                <th class="px-4 py-4 text-left text-sm font-semibold">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</th>
                <th class="px-4 py-4 text-left text-sm font-semibold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th class="px-4 py-4 text-left text-sm font-semibold">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                <th class="px-4 py-4 text-left text-sm font-semibold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody id="report-table-body" class="divide-y divide-gray-100">
              <!-- Data rows will be inserted here -->
            </tbody>
          </table>
        </div>

        <!-- ‚úÖ NEW: Pagination Bar -->
        <div id="pagination-bar" class="hidden p-4 border-t border-gray-200 bg-gray-50 flex flex-wrap items-center justify-between gap-3">
          <div class="flex items-center gap-2">
            <button id="pg-prev" onclick="setPage(pagination.page - 1)"
              class="px-3 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-100 text-sm font-medium">
              ‚óÄ ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
            </button>

            <div class="text-sm text-gray-700">
              ‡∏´‡∏ô‡πâ‡∏≤ <span id="pg-page">1</span> / <span id="pg-total">1</span>
              <span class="text-gray-400 mx-1">|</span>
              ‡πÅ‡∏™‡∏î‡∏á <span id="pg-range">0-0</span>
            </div>

            <button id="pg-next" onclick="setPage(pagination.page + 1)"
              class="px-3 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-100 text-sm font-medium">
              ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ñ∂
            </button>
          </div>

          <div class="flex items-center gap-2">
            <span class="text-sm text-gray-700">‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤</span>
            <select id="pg-size" onchange="setPageSize(this.value)"
              class="px-3 py-2 rounded-lg border border-gray-300 bg-white text-sm">
              <option value="25">25</option>
              <option value="50" selected>50</option>
              <option value="100">100</option>
              <option value="200">200</option>
            </select>
          </div>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden p-12 text-center">
          <div class="w-24 h-24 mx-auto mb-4 rounded-full bg-gradient-to-br from-blue-100 to-indigo-100 flex items-center justify-center">
            <svg class="w-12 h-12 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
          </div>
          <h3 class="text-xl font-semibold text-gray-700 mb-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h3>
          <p class="text-gray-500 mb-4">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏á‡∏≤‡∏ô</p>
        </div>
      </div>
    </div>

    <!-- ‚úÖ NEW: Summary Page (‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö Summary Modal ‡πÄ‡∏î‡∏¥‡∏°) -->
    <div id="summary-page" class="hidden min-h-full p-4 md:p-6 lg:p-8">
      <header class="glass-card rounded-2xl p-6 mb-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <h1 class="text-2xl md:text-3xl font-bold text-white">üìÑ ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ù‡∏∂‡∏Å‡∏á‡∏≤‡∏ô</h1>
            <p class="text-blue-100 mt-1">‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° + Breakdown + Data Quality</p>
          </div>
          <div class="flex gap-3">
            <button onclick="closeSummaryPage()" class="btn-primary text-white px-6 py-3 rounded-xl font-medium shadow-lg">
              ‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Dashboard
            </button>
          </div>
        </div>
      </header>

      <div class="glass-card-solid rounded-2xl shadow-xl overflow-hidden">
        <div class="p-6 space-y-6">
          <div class="text-right text-gray-500 text-sm">
            ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡∏∏‡∏õ: <span id="summary-date-page"></span>
          </div>

          <div id="summary-overall-page" class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-5"></div>
          <div id="summary-top-insights-page" class="bg-white rounded-xl border border-gray-200 p-5"></div>

          <div class="bg-white rounded-xl border border-gray-200 p-5">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">üéì Breakdown ‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏Ç‡∏≤</h3>
            <div id="summary-by-department-page" class="overflow-x-auto"></div>
          </div>

          <div class="bg-white rounded-xl border border-gray-200 p-5">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">üìÖ Breakdown ‡∏ï‡∏≤‡∏°‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h3>
            <div id="summary-by-year-page" class="overflow-x-auto"></div>
          </div>

          <div id="summary-warnings-page" class="bg-white rounded-xl border border-gray-200 p-5"></div>
        </div>
      </div>
    </div>

    <!-- Add Report Modal -->
    <div id="add-modal" class="fixed inset-0 z-40 hidden">
      <div class="modal-overlay absolute inset-0" onclick="closeAddModal()"></div>
      <div class="relative min-h-full flex items-center justify-center p-4">
        <div class="glass-card-solid rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto my-4">
          <div class="p-6 border-b border-gray-200 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-t-2xl">
            <div class="flex items-center justify-between">
              <h2 class="text-xl font-bold text-white">üìù ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</h2>
              <button onclick="closeAddModal()" class="text-white hover:bg-white/20 rounded-lg p-2 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          </div>

          <form id="add-form" class="p-6 space-y-5">
            <!-- Academic Year Selection -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ <span class="text-red-500">*</span></label>
              <select id="form-academic-year" onchange="updateStudentDropdown()" required
                class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ --</option>
                <option value="2560">2560</option>
                <option value="2561">2561</option>
                <option value="2562">2562</option>
                <option value="2563">2563</option>
                <option value="2564">2564</option>
                <option value="2565">2565</option>
                <option value="2566">2566</option>
                <option value="2567">2567</option>
                <option value="2568">2568</option>
                <option value="2569">2569</option>
                <option value="2570">2570</option>
                <option value="2571">2571</option>
                <option value="2572">2572</option>
                <option value="2573">2573</option>
                <option value="2574">2574</option>
                <option value="2575">2575</option>
                <option value="2576">2576</option>
                <option value="2577">2577</option>
                <option value="2578">2578</option>
                <option value="2579">2579</option>
                <option value="2580">2580</option>
              </select>
            </div>

            <!-- Student Selection -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ <span class="text-red-500">*</span></label>
              <select id="form-student-select" onchange="fillStudentInfo()" required disabled
                class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100">
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Å‡πà‡∏≠‡∏ô --</option>
              </select>
            </div>

            <!-- Trip History Display -->
            <div id="trip-history-display"></div>

            <!-- Auto-filled Fields -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
                <input type="text" id="form-student-id" readonly
                  class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-gray-50 text-gray-600">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡∏≤‡∏Ç‡∏≤</label>
                <input type="text" id="form-department" readonly
                  class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-gray-50 text-gray-600">
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
              <input type="text" id="form-student-name" readonly
                class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-gray-50 text-gray-600">
            </div>

            <!-- Boarding & Return Dates -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡πÄ‡∏£‡∏∑‡∏≠ <span class="text-red-500">*</span></label>
                <input type="date" id="form-boarding-date" required
                  class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏•‡∏±‡∏ö/‡∏•‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏£‡∏∑‡∏≠ <span class="text-red-500">*</span></label>
                <input type="date" id="form-return-date" required
                  class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              </div>
            </div>

            <!-- Ship & Company -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡∏≠ <span class="text-red-500">*</span></label>
                <input type="text" id="form-ship-name" required placeholder="‡πÄ‡∏ä‡πà‡∏ô M/V Ocean Star"
                  class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó <span class="text-red-500">*</span></label>
                <input type="text" id="form-company-name" required placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏£‡∏∑‡∏≠"
                  class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              </div>
            </div>

            <!-- Optional Dates -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà JOIN</label>
                <input type="date" id="form-join-date"
                  class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà LEAVE</label>
                <input type="date" id="form-leave-date"
                  class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏•‡∏á‡∏•‡∏≥‡∏ó‡∏µ‡πà</label>
                <input type="number" id="form-trip-number" min="1" placeholder="1"
                  class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              </div>
            </div>

            <!-- Work Details -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label>
              <textarea id="form-work-details" rows="3" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏á‡∏≤‡∏ô..."
                class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"></textarea>
            </div>

            <!-- Notes -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
              <textarea id="form-notes" rows="2" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."
                class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"></textarea>
            </div>

            <!-- Submit Button -->
            <div class="flex gap-3 pt-4">
              <button type="button" onclick="closeAddModal()"
                class="flex-1 px-6 py-3 rounded-xl border border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-colors">
                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
              </button>
              <button type="submit" id="submit-btn"
                class="flex-1 btn-primary text-white px-6 py-3 rounded-xl font-medium flex items-center justify-center gap-2">
                <span id="submit-text">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                <div id="submit-spinner" class="spinner hidden"></div>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Summary Modal -->
    <div id="summary-modal" class="fixed inset-0 z-40 hidden overflow-y-auto">
      <div class="modal-overlay absolute inset-0 z-0" onclick="closeSummaryModal()"></div>
      <div class="relative z-10 min-h-full flex items-start justify-center p-4 py-6">
        <div class="glass-card-solid rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto my-4">
          <div class="p-6 border-b border-gray-200 bg-gradient-to-r from-emerald-600 to-teal-600 rounded-t-2xl">
            <div class="flex items-center justify-between">
              <h2 class="text-xl font-bold text-white">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ù‡∏∂‡∏Å‡∏á‡∏≤‡∏ô</h2>
              <button onclick="closeSummaryModal()" class="text-white hover:bg-white/20 rounded-lg p-2 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          </div>

          <div class="p-6 space-y-6">
            <!-- Summary Date -->
            <div class="text-right text-gray-500 text-sm">
              ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡∏∏‡∏õ: <span id="summary-date"></span>
            </div>

            <!-- Overall Summary -->
            <div id="summary-overall" class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-5"></div>

            <!-- Top Insights -->
            <div id="summary-top-insights" class="bg-white rounded-xl border border-gray-200 p-5"></div>

            <!-- Department Breakdown -->
            <div class="bg-white rounded-xl border border-gray-200 p-5">
              <h3 class="text-lg font-semibold text-gray-800 mb-4">üéì Breakdown ‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏Ç‡∏≤</h3>
              <div id="summary-by-department" class="overflow-x-auto"></div>
            </div>

            <!-- Year Breakdown -->
            <div class="bg-white rounded-xl border border-gray-200 p-5">
              <h3 class="text-lg font-semibold text-gray-800 mb-4">üìÖ Breakdown ‡∏ï‡∏≤‡∏°‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h3>
              <div id="summary-by-year" class="overflow-x-auto"></div>
            </div>

            <!-- Data Quality / Warnings -->
            <div id="summary-warnings" class="bg-white rounded-xl border border-gray-200 p-5"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /** =========================================================
     *  ‚úÖ Firebase Config (‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á dataSdk ‡πÅ‡∏•‡∏∞ students)
     * ========================================================= */
    const firebaseConfig = {
      apiKey: "AIzaSyC-kwdTAPH9Vdqy9PABUAjMv635aZLQh8s",
      authDomain: "studentreport-management.firebaseapp.com",
      databaseURL: "https://studentreport-management-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "studentreport-management",
      storageBucket: "studentreport-management.firebasestorage.app",
      messagingSenderId: "1016576456872",
      appId: "1:1016576456872:web:0d82f2a82e99e53a4b6a9d",
      measurementId: "G-5TK1HK3HBC"
    };

    // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ onclick ‡πÉ‡∏ô HTML ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÑ‡∏î‡πâ
    Object.assign(window, {
      openAddModal,
      closeAddModal,
      openStudentModal,
      closeStudentModal,
      openSummaryModal,
      closeSummaryModal,
      openSummaryPage,     // ‚úÖ NEW
      closeSummaryPage,    // ‚úÖ NEW
      openExportModal,     // ‚úÖ NEW
      closeExportModal,    // ‚úÖ NEW
      exportReportsCSV,    // ‚úÖ NEW
      exportReportsXLSX,   // ‚úÖ NEW
      exportStudentsCSV,   // ‚úÖ NEW
      exportStudentsXLSX,  // ‚úÖ NEW
      setPage,             // ‚úÖ NEW
      setPageSize,         // ‚úÖ NEW
      updateStudentDropdown,
      fillStudentInfo,
      clearStudentInfo,
      renderTable,
      updateStatus,
      openEditModal,
      closeEditModal,
      deleteReport,
      cancelOverlapSubmit,
      confirmOverlapSubmit,
      deleteStudent
    });

    // ============================================
    // STUDENT DATABASE
    // ============================================
    const studentDatabase = {
      "DECK": {
        "2566": {
          "1571": { id: "1571", fullName: "‡∏ô‡∏≤‡∏¢‡∏Å‡∏¥‡∏ï‡∏ï‡∏¥‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ‡πÇ‡∏™‡∏ô‡∏∞‡∏à‡∏¥‡∏ï‡∏£" },
          "1569": { id: "1569", fullName: "‡∏ô‡∏≤‡∏¢‡∏û‡∏á‡∏®‡∏Å‡∏£ ‡∏Ñ‡∏≥‡∏†‡∏π" },
          "1568": { id: "1568", fullName: "‡∏ô‡∏≤‡∏¢‡∏®‡∏∏‡∏†‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê‡∏à‡∏¥‡∏ï‡∏ï‡πå" },
          "1573": { id: "1573", fullName: "‡∏ô‡∏≤‡∏¢‡∏Å‡∏§‡∏©‡∏é‡∏≤ ‡∏´‡∏≠‡∏°‡∏Ç‡∏à‡∏£" },
          "1580": { id: "1580", fullName: "‡∏ô‡∏≤‡∏¢‡∏ò‡∏±‡∏ô‡∏ß‡πå ‡∏û‡∏¥‡∏ó‡∏±‡∏Å‡∏©‡πå‡∏ò‡∏£‡∏£‡∏°‡∏ì‡∏µ" },
          "1566": { id: "1566", fullName: "‡∏ô‡∏≤‡∏¢‡πÄ‡∏•‡∏¥‡∏®‡∏≠‡∏ô‡∏±‡∏ô‡∏ï‡πå ‡πÄ‡∏ï‡∏ä‡∏ß‡∏±‡∏í‡∏ô‡πå‡∏ò‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå" },
          "1584": { id: "1584", fullName: "‡∏ô‡∏≤‡∏¢‡∏Ñ‡∏∏‡∏ì‡∏≤‡∏ô‡∏ô‡∏ï‡πå ‡∏°‡∏±‡∏ç‡∏ä‡∏∏‡∏™‡∏≤‡∏£‡∏±‡∏ï‡∏ô‡πå" },
          "1574": { id: "1574", fullName: "‡∏ô‡∏≤‡∏¢‡∏£‡∏∞‡∏û‡∏µ‡∏û‡∏±‡∏í‡∏ô‡πå ‡∏à‡∏≠‡∏á‡∏£‡∏∞‡∏´‡∏á‡∏©‡πå" },
          "1570": { id: "1570", fullName: "‡∏ô‡∏≤‡∏¢‡∏™‡∏´‡∏±‡∏™‡∏ß‡∏£‡∏£‡∏©‡πå ‡∏Ñ‡∏¥‡∏î‡∏°‡∏≤" },
          "1715": { id: "1715", fullName: "‡∏ô‡∏≤‡∏¢‡∏Å‡∏¥‡∏ï‡∏ï‡∏¥ ‡∏®‡∏£‡∏µ‡∏™‡∏∏‡∏Ç" },
          "1575": { id: "1575", fullName: "‡∏ô‡∏≤‡∏¢‡∏®‡∏£‡∏≤‡∏ß‡∏∏‡∏ò ‡∏´‡∏ß‡∏±‡∏ô‡∏•‡∏∞‡πÄ‡∏ö‡πä‡∏∞" },
          "1583": { id: "1583", fullName: "‡∏ô‡∏≤‡∏¢‡∏ì‡∏±‡∏ê‡∏û‡∏á‡∏®‡πå ‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê‡∏î‡∏µ" },
          "1576": { id: "1576", fullName: "‡∏ô‡∏≤‡∏¢‡∏£‡∏ä‡∏≤‡∏ô‡∏ô‡∏ó‡πå ‡∏™‡∏∏‡∏î‡∏û‡∏∏‡πà‡∏°" },
          "1717": { id: "1717", fullName: "‡∏ô‡∏≤‡∏¢‡∏ò‡∏ô‡∏û‡∏±‡∏í‡∏ô‡πå ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç" }
        },
        "2567": {
          "‡∏ä‡∏ô‡∏≤‡∏ò‡∏¥‡∏õ": { id: "1919", fullName: "‡∏ô‡∏≤‡∏¢‡∏ä‡∏ô‡∏≤‡∏ò‡∏¥‡∏õ ‡∏ó‡∏¥‡∏û‡∏¢‡πå‡∏≠‡∏∏‡∏ó‡∏±‡∏¢" },
          "‡∏ì‡∏±‡∏ê‡∏û‡∏ô‡∏ò‡πå": { id: "2002", fullName: "‡∏ô‡∏≤‡∏¢‡∏ì‡∏±‡∏ê‡∏û‡∏ô‡∏ò‡πå ‡πÅ‡∏™‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê" },
          "‡∏†‡∏≤‡∏ô‡∏∏‡∏û‡∏á‡∏®‡πå": { id: "2004", fullName: "‡∏ô‡∏≤‡∏¢‡∏†‡∏≤‡∏ô‡∏∏‡∏û‡∏á‡∏®‡πå ‡πÄ‡∏≠‡∏µ‡πà‡∏¢‡∏°‡πÇ‡∏≠‡∏î" },
          "‡∏≠‡∏∏‡∏ì‡∏û‡∏±‡∏ó‡∏ò‡πå": { id: "2005", fullName: "‡∏ô‡∏≤‡∏¢‡∏≠‡∏∏‡∏ì‡∏û‡∏±‡∏ó‡∏ò‡πå ‡∏ß‡∏á‡∏®‡πå‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏û‡∏£" },
          "‡∏ô‡∏±‡∏ô‡∏ó‡∏ß‡∏±‡∏í‡∏ô‡πå": { id: "2007", fullName: "‡∏ô‡∏≤‡∏¢‡∏ô‡∏±‡∏ô‡∏ó‡∏ß‡∏±‡∏í‡∏ô‡πå ‡∏¢‡∏≤‡∏î‡∏µ" },
          "‡∏ò‡∏ô‡∏û‡∏•1": { id: "2008", fullName: "‡∏ô‡∏≤‡∏¢‡∏ò‡∏ô‡∏û‡∏• ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°" },
          "‡∏™‡∏°‡∏¢‡∏®": { id: "2009", fullName: "‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏¢‡∏® ‡∏û‡∏£‡πâ‡∏≤‡πÄ‡∏û‡∏£‡∏µ‡∏¢‡∏á" },
          "‡∏ò‡∏±‡∏ä‡∏û‡∏•": { id: "2010", fullName: "‡∏ô‡∏≤‡∏¢‡∏ò‡∏±‡∏ä‡∏û‡∏• ‡∏ô‡∏¥‡∏Ñ‡∏°" },
          "‡∏®‡∏¥‡∏ß‡∏õ‡∏£‡∏µ‡∏ä‡∏≤": { id: "2011", fullName: "‡∏ô‡∏≤‡∏¢‡∏®‡∏¥‡∏ß‡∏õ‡∏£‡∏µ‡∏ä‡∏≤ ‡∏Å‡∏≥‡∏£‡∏≤‡∏ö‡∏†‡∏±‡∏¢" },
          "‡πÄ‡∏à‡∏©‡∏é‡∏≤": { id: "2014", fullName: "‡∏ô‡∏≤‡∏¢‡πÄ‡∏à‡∏©‡∏é‡∏≤ ‡∏à‡∏¥‡∏ì‡∏ì‡∏ò‡∏ô‡∏û‡∏á‡∏©‡πå" },
          "‡∏≠‡∏ô‡∏∏‡∏ï‡∏£": { id: "2015", fullName: "‡∏ô‡∏≤‡∏¢‡∏≠‡∏ô‡∏∏‡∏ï‡∏£ ‡∏ó‡πâ‡∏ß‡∏°‡∏™‡∏±‡∏á‡∏Ç‡πå" },
          "‡∏ò‡∏ô‡∏û‡∏•2": { id: "2073", fullName: "‡∏ô‡∏≤‡∏¢‡∏ò‡∏ô‡∏û‡∏• ‡∏õ‡∏¥‡∏ô‡∏ï‡∏≤‡πÑ‡∏ù" }
        }
      },

      "PCP": {
        "2566": {
          "1417": { id: "1417", fullName: "‡∏ô‡∏≤‡∏¢‡∏à‡∏¥‡∏£‡∏ß‡∏±‡∏í‡∏ô‡πå ‡∏®‡∏£‡∏µ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå" },
          "1421": { id: "1421", fullName: "‡∏ô‡∏≤‡∏¢‡∏ò‡∏ô‡∏ß‡∏¥‡∏ô‡∏ó‡πå ‡∏™‡∏∏‡∏õ‡∏¥‡∏ô‡∏ö‡∏∏‡∏ï‡∏£" },
          "1423": { id: "1423", fullName: "‡∏ô‡∏≤‡∏¢‡∏ö‡∏î‡∏¥‡∏ô‡∏ó‡∏£‡πå ‡∏™‡∏∏‡∏Ç‡∏≤‡∏ô‡∏Ñ‡∏£" },
          "1425": { id: "1425", fullName: "‡∏ô‡∏≤‡∏¢‡∏ß‡∏±‡∏ä‡∏£‡∏∞ ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏õ‡∏£‡∏∞‡∏†‡∏≤" }
        },
        "2567": {
          "‡∏ì‡∏±‡∏ê‡∏û‡∏á‡∏®‡πå": { id: "1508", fullName: "‡∏ô‡∏≤‡∏¢‡∏ì‡∏±‡∏ê‡∏û‡∏á‡∏®‡πå ‡∏´‡∏≤‡∏Ñ‡∏≥‡πÄ‡∏•" },
          "‡∏™‡∏û‡∏•‡∏î‡∏ô‡∏±‡∏¢": { id: "1509", fullName: "‡∏ô‡∏≤‡∏¢‡∏™‡∏û‡∏•‡∏î‡∏ô‡∏±‡∏¢ ‡∏´‡∏≤‡∏ç‡∏ì‡∏£‡∏á‡∏Ñ‡πå" },
          "‡∏Å‡∏§‡∏©‡∏ì‡πå": { id: "1510", fullName: "‡∏ô‡∏≤‡∏¢‡∏Å‡∏§‡∏©‡∏ì‡πå ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏ß‡∏¥‡∏£‡∏±‡∏ï‡∏ô‡πå" },
          "‡∏Å‡∏¥‡∏ï‡∏ï‡∏¥‡∏ä‡∏±‡∏¢": { id: "1511", fullName: "‡∏ô‡∏≤‡∏¢‡∏Å‡∏¥‡∏ï‡∏ï‡∏¥‡∏ä‡∏±‡∏¢ ‡∏°‡∏π‡∏•‡πÄ‡∏ó‡∏û‡∏û‡∏¥‡∏ä‡∏±‡∏¢" },
          "‡∏õ‡∏Å‡∏£‡∏ì‡πå": { id: "1513", fullName: "‡∏ô‡∏≤‡∏¢‡∏õ‡∏Å‡∏£‡∏ì‡πå ‡∏õ‡∏¥‡∏¢‡∏∞‡∏ô‡∏±‡∏ô‡∏ó‡πå" },
          "‡πÑ‡∏Å‡∏£‡∏ß‡∏¥‡∏ä‡∏ç‡πå": { id: "1514", fullName: "‡∏ô‡∏≤‡∏¢‡πÑ‡∏Å‡∏£‡∏ß‡∏¥‡∏ä‡∏ç‡πå ‡∏ö‡∏∏‡∏ç‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê" },
          "‡∏≠‡∏¥‡∏®‡∏£‡∏≤‡∏ô‡∏∏‡∏ß‡∏±‡∏í‡∏ô‡πå": { id: "1516", fullName: "‡∏ô‡∏≤‡∏¢‡∏≠‡∏¥‡∏®‡∏£‡∏≤‡∏ô‡∏∏‡∏ß‡∏±‡∏í‡∏ô‡πå ‡∏ä‡∏±‡∏¢‡∏†‡∏≤‡∏™‡∏ä‡∏°‡∏†‡∏π" },
          "‡∏ò‡∏±‡∏ç‡∏ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå": { id: "1518", fullName: "‡∏ô‡∏≤‡∏¢‡∏ò‡∏±‡∏ç‡∏ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ‡∏à‡∏±‡∏ô‡∏ó‡∏£" },
          "‡∏ß‡∏£‡∏û‡∏á‡∏®‡πå": { id: "1519", fullName: "‡∏ô‡∏≤‡∏¢‡∏ß‡∏£‡∏û‡∏á‡∏®‡πå ‡∏ó‡πâ‡∏ß‡∏°‡∏£‡∏≠‡∏î" },
          "‡∏û‡∏á‡∏®‡∏Å‡∏£": { id: "1520", fullName: "‡∏ô‡∏≤‡∏¢‡∏û‡∏á‡∏®‡∏Å‡∏£ ‡∏ö‡∏∏‡∏î‡∏î‡∏µ" },
          "‡∏Å‡∏¥‡∏ï‡∏ï‡∏¥‡∏†‡∏û": { id: "1521", fullName: "‡∏ô‡∏≤‡∏¢‡∏Å‡∏¥‡∏ï‡∏ï‡∏¥‡∏†‡∏û ‡∏â‡∏±‡∏ï‡∏£‡πÅ‡∏Å‡πâ‡∏ß" }
        }
      },

      "ENGINE": {
        "2566": {
          "1563": { id: "1563", fullName: "‡∏ô‡∏≤‡∏¢‡∏≠‡∏†‡∏¥‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ‡∏ß‡∏á‡∏®‡πå‡∏´‡∏ô‡∏π‡∏û‡∏∞‡πÄ‡∏ô‡∏≤" },
          "1565": { id: "1565", fullName: "‡∏ô‡∏≤‡∏¢‡∏≠‡∏†‡∏¥‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ‡∏£‡∏≤‡πÇ‡∏£‡∏à‡∏ô‡πå" },
          "1562": { id: "1562", fullName: "‡∏ô‡∏≤‡∏¢‡∏ä‡∏¢‡∏ì‡∏±‡∏ê ‡∏ö‡∏∏‡∏ç‡∏Ñ‡∏£‡∏≠‡∏á" }
        }
      }
    };

    // ============================================
    // DATA STATE
    // ============================================
    let allReports = [];
    let isSubmitting = false;
    let pendingTripData = null;
    let pendingOverlapConfirmed = false;

    // ============================================
    // ‚úÖ NEW: PAGINATION STATE
    // ============================================
    const pagination = {
      page: 1,
      pageSize: 50,
      lastKey: ''
    };

    function setPage(p) {
      pagination.page = Math.max(1, parseInt(p, 10) || 1);
      renderTable();
    }

    function setPageSize(size) {
      pagination.pageSize = Math.max(1, parseInt(size, 10) || 50);
      pagination.page = 1;
      renderTable();
    }

    function updatePaginationBar(total, totalPages, startIdx, endIdx) {
      const bar = document.getElementById('pagination-bar');
      if (!bar) return;

      if (total <= 0) {
        bar.classList.add('hidden');
        return;
      }
      bar.classList.remove('hidden');

      const pgPage = document.getElementById('pg-page');
      const pgTotal = document.getElementById('pg-total');
      const pgRange = document.getElementById('pg-range');
      const btnPrev = document.getElementById('pg-prev');
      const btnNext = document.getElementById('pg-next');
      const selSize = document.getElementById('pg-size');

      if (pgPage) pgPage.textContent = String(pagination.page);
      if (pgTotal) pgTotal.textContent = String(totalPages);
      if (pgRange) pgRange.textContent = `${startIdx}-${endIdx} ‡∏à‡∏≤‡∏Å ${total}`;

      if (btnPrev) btnPrev.disabled = (pagination.page <= 1);
      if (btnNext) btnNext.disabled = (pagination.page >= totalPages);

      if (selSize && String(selSize.value) !== String(pagination.pageSize)) {
        selSize.value = String(pagination.pageSize);
      }
    }

    // ============================================
    // CONFIG
    // ============================================
    const defaultConfig = { dashboard_title: "üö¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ù‡∏∂‡∏Å‡∏á‡∏≤‡∏ô" };

    // ============================================
    // STATUS NORMALIZATION
    // ============================================
    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°: APPLIED, ON LEAVE - WAIT FOR GRADUATION PROCESS
    const ALLOWED_STATUSES = [
      'NO REQUEST TO JOIN THE SHIP',
      'THE VOYAGE PROCESS',
      'READY TO JOIN SHIP',
      'ON BOARD',
      'ON LEAVE - APPLY FOR GRADUATION',
      'ON LEAVE - WAIT FOR GRADUATION PROCESS',
      'ON LEAVE - OWN BUSINESS',
      'ON LEAVE - WAIT FOR REJOIN',
      'GRADUATED'
    ];

    function normalizeStatus(status) {
      const DEFAULT = 'NO REQUEST TO JOIN THE SHIP';
      if (status === null || status === undefined) return DEFAULT;

      const raw = String(status).trim();
      if (!raw) return DEFAULT;

      const u = raw.toUpperCase().replace(/\s+/g, ' ').trim();


      // Backward compatibility
      if (u === 'PENDING') return 'READY TO JOIN SHIP';
      if (u === 'STANDBYFORSHIP' || u === 'STANDBY FOR SHIP') return 'READY TO JOIN SHIP';
      if (u === 'ONBOARD' || u === 'ON BOARD') return 'ON BOARD';
      if (u === 'GRADUATION' || u === 'GRAD' || u === 'GRADUATED') return 'GRADUATED';

      // Flexible inputs
      if (u.includes('NO REQUEST')) return 'NO REQUEST TO JOIN THE SHIP';
      if (u.includes('VOYAGE')) return 'THE VOYAGE PROCESS';
      if (u.includes('READY') && u.includes('JOIN')) return 'READY TO JOIN SHIP';

      // ON LEAVE
      if (u.startsWith('ON LEAVE')) {
        // ‚úÖ NEW: WAIT FOR GRADUATION PROCESS
        if (u.includes('WAIT') && u.includes('GRAD')) return 'ON LEAVE - WAIT FOR GRADUATION PROCESS';

        if (u.includes('GRAD')) return 'ON LEAVE - APPLY FOR GRADUATION';
        if (u.includes('OWN') || u.includes('BUSINESS')) return 'ON LEAVE - OWN BUSINESS';
        if (u.includes('REJOIN') || u.includes('WAIT')) return 'ON LEAVE - WAIT FOR REJOIN';
        return 'ON LEAVE - WAIT FOR REJOIN';
      }

      const exact = ALLOWED_STATUSES.find(s => s === u);
      if (exact) return exact;

      return DEFAULT;
    }

    function isOnLeaveStatus(status) {
      return normalizeStatus(status).startsWith('ON LEAVE -');
    }

    // ============================================
    // MULTI-TRIP SUPPORT
    // ============================================
    function isDateOverlap(aStart, aEnd, bStart, bEnd) {
      const a1 = new Date(aStart).getTime();
      const a2 = new Date(aEnd).getTime();
      const b1 = new Date(bStart).getTime();
      const b2 = new Date(bEnd).getTime();

      if (isNaN(a1) || isNaN(a2) || isNaN(b1) || isNaN(b2)) return false;
      if (a2 < a1 || b2 < b1) return false;
      return a1 <= b2 && b1 <= a2;
    }

    function computeNextTripSeq(allReports, studentId, academicYear) {
      const existingTrips = allReports.filter(r => r.student_id === studentId && r.academic_year === academicYear);
      if (existingTrips.length === 0) return 1;
      const maxSeq = Math.max(...existingTrips.map(r => r.trip_seq || 0));
      return maxSeq + 1;
    }

    function buildTripId(formData) {
      const { student_id, academic_year, ship_name, boarding_date } = formData;
      const sanitizedShip = (ship_name || '')
        .replace(/\s+/g, '-')
        .replace(/[^a-zA-Z0-9-]/g, '')
        .toUpperCase();
      return `${student_id}_${academic_year}_${sanitizedShip}_${boarding_date}`;
    }

    function duplicateCheck(allReports, formData) {
      const duplicate = allReports.find(r =>
        r.student_id === formData.student_id &&
        r.academic_year === formData.academic_year &&
        r.ship_name === formData.ship_name &&
        r.boarding_date === formData.boarding_date &&
        r.return_date === formData.return_date
      );
      return duplicate || null;
    }

    function findOverlappingTrips(allReports, formData) {
      const { student_id, academic_year, boarding_date, return_date } = formData;

      const studentTrips = allReports.filter(r => r.student_id === student_id && r.academic_year === academicYear);
      const overlapping = studentTrips.filter(trip => isDateOverlap(boarding_date, return_date, trip.boarding_date, trip.return_date));
      return overlapping;
    }

    function getRecentTrips(allReports, studentId, limit = 3) {
      return allReports
        .filter(r => r.student_id === studentId)
        .sort((a, b) => new Date(b.boarding_date) - new Date(a.boarding_date))
        .slice(0, limit);
    }

    // ============================================
    // DATA HANDLER
    // ============================================
    const dataHandler = {
      onDataChanged(data) {
        allReports = data || [];
        updateStats();
        renderTable();
        // ‚úÖ NEW: refresh insights whenever data changes
        renderDashboardInsights();

        // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤ Summary Page ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        const page = document.getElementById('summary-page');
        if (page && !page.classList.contains('hidden')) {
          updateSummaryPage();
        }
      }
    };

    // ============================================
    // STUDENTS (Firestore)
    // ============================================
    let allStudents = [];
    let studentsUnsub = null;

    function initFirebaseIfNeeded() {
      if (!firebase?.apps?.length) firebase.initializeApp(firebaseConfig);
    }

    async function ensureAuthGlobal() {
      try {
        initFirebaseIfNeeded();
        const auth = firebase.auth();
        if (auth.currentUser) return true;
        await auth.signInAnonymously();
        return true;
      } catch (e) {
        console.error('Auth failed:', e);
        return false;
      }
    }

    function openStudentModal() {
      document.getElementById('student-modal').classList.remove('hidden');
      renderStudentList();
    }
    function closeStudentModal() {
      document.getElementById('student-modal').classList.add('hidden');
    }

    function buildStudentDocId(year, dept, id) {
      return `${year}_${id}_${dept}`.replace(/\s+/g, '_');
    }

    function renderStudentList() {
      const el = document.getElementById('student-list');
      if (!el) return;

      const rows = allStudents
        .slice()
        .sort((a, b) =>
          (a.academic_year || '').localeCompare(b.academic_year || '') ||
          (a.department || '').localeCompare(b.department || '') ||
          (a.id || '').localeCompare(b.id || '')
        );

      if (rows.length === 0) {
        el.innerHTML = `<p class="text-gray-500 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏ô Firestore</p>`;
        return;
      }

      el.innerHTML = `
        <table class="min-w-[900px] w-full text-sm">
          <thead>
            <tr class="bg-gray-50 text-gray-700">
              <th class="text-left px-3 py-2 font-semibold">‡∏õ‡∏µ</th>
              <th class="text-left px-3 py-2 font-semibold">‡∏™‡∏≤‡∏Ç‡∏≤</th>
              <th class="text-left px-3 py-2 font-semibold">‡∏£‡∏´‡∏±‡∏™</th>
              <th class="text-left px-3 py-2 font-semibold">‡∏ä‡∏∑‡πà‡∏≠</th>
              <th class="text-left px-3 py-2 font-semibold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            ${rows.map(s => `
              <tr>
                <td class="px-3 py-2">${escapeHtml(s.academic_year || '')}</td>
                <td class="px-3 py-2">${escapeHtml(s.department || '')}</td>
                <td class="px-3 py-2 font-medium">${escapeHtml(s.id || '')}</td>
                <td class="px-3 py-2">${escapeHtml(s.fullName || '')}</td>
                <td class="px-3 py-2">
                  <button onclick="deleteStudent('${s.__backendId}')"
                          class="px-3 py-2 rounded-lg bg-red-100 text-red-700 hover:bg-red-200 font-medium">
                    üóëÔ∏è ‡∏•‡∏ö
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function deleteStudent(docId) {
      const ok = confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?');
      if (!ok) return;

      const authed = await ensureAuthGlobal();
      if (!authed) return showToast('Auth ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô', 'error');

      try {
        const db = firebase.firestore();
        await db.collection('students').doc(docId).delete();
        showToast('‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
      } catch (e) {
        console.error(e);
        showToast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
      }
    }

    async function startStudentsListener() {
      const authed = await ensureAuthGlobal();
      if (!authed) return;

      const db = firebase.firestore();
      if (studentsUnsub) studentsUnsub();

      studentsUnsub = db.collection('students').onSnapshot(snap => {
        allStudents = snap.docs.map(d => ({ ...(d.data() || {}), __backendId: d.id }));
        renderStudentList();
      }, e => console.error('students onSnapshot error:', e));
    }

    (function bindStudentForm() {
      const sf = document.getElementById('student-form');
      if (!sf) {
        document.addEventListener('DOMContentLoaded', bindStudentForm, { once: true });
        return;
      }
      if (sf.__bound) return;
      sf.__bound = true;

      sf.addEventListener('submit', async function (e) {
        e.preventDefault();

        const year = document.getElementById('stu-year').value.trim();
        const dept = document.getElementById('stu-dept').value.trim();
        const id = document.getElementById('stu-id').value.trim();
        const name = document.getElementById('stu-name').value.trim();

        if (!year || !dept || !id || !name) return showToast('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'error');

        const authed = await ensureAuthGlobal();
        if (!authed) return showToast('Auth ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô', 'error');

        try {
          const db = firebase.firestore();
          const docId = buildStudentDocId(year, dept, id);

          await db.collection('students').doc(docId).set({
            academic_year: year,
            department: dept,
            id,
            fullName: name,
            updated_at: new Date().toISOString()
          }, { merge: true });

          showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
          document.getElementById('student-form').reset();

          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï dropdown ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
          updateStudentDropdown();
        } catch (e2) {
          console.error(e2);
          showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
        }
      });

      // ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (‡∏ê‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏° + Firestore)
      function getStudentsForYear(year) {
        const list = [];

        // base (studentDatabase)
        for (const [dept, years] of Object.entries(studentDatabase)) {
          if (!years[year]) continue;
          for (const info of Object.values(years[year])) {
            list.push({ department: dept, id: info.id, fullName: info.fullName });
          }
        }

        // dynamic (Firestore)
        allStudents
          .filter(s => String(s.academic_year || '') === String(year))
          .forEach(s => list.push({ department: s.department || '', id: s.id || '', fullName: s.fullName || '' }));

        // dedupe dept|id
        const seen = new Set();
        return list.filter(s => {
          const key = `${s.department}|${s.id}`;
          if (!s.id || seen.has(key)) return false;
          seen.add(key);
          return true;
        });
      }
      window.getStudentsForYear = getStudentsForYear;

    })();

    // ============================================
    // INIT APP
    // ============================================
    async function initApp() {
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            const titleEl = document.getElementById('dashboard-title');
            if (titleEl) titleEl.textContent = config.dashboard_title || defaultConfig.dashboard_title;
          },
          mapToCapabilities: (config) => ({
            recolorables: [],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ["dashboard_title", config.dashboard_title || defaultConfig.dashboard_title]
          ])
        });
      }

      if (window.dataSdk) {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
      }

      startStudentsListener();
      updateStats();
      renderTable();
      renderDashboardInsights(); // ‚úÖ NEW
    }

    /** =========================================================
     *  dataSdk Fallback (Firestore) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö GitHub Pages
     * ========================================================= */
    (function () {
      if (window.dataSdk) return;

      const ok = (value) => ({ isOk: true, value });
      const err = (error) => ({ isOk: false, error });

      let handlerRef = null;
      let unsubscribe = null;

      function initFirebaseOnce() {
        if (!firebase?.apps?.length) firebase.initializeApp(firebaseConfig);
      }

      async function ensureAuth() {
        try {
          initFirebaseOnce();
          const auth = firebase.auth();
          if (!auth.currentUser) await auth.signInAnonymously();
          return true;
        } catch (e) {
          console.error("Anonymous sign-in failed:", e);
          return false;
        }
      }

      function mapDoc(docSnap) {
        const data = docSnap.data() || {};
        data.__backendId = docSnap.id;
        return data;
      }

      window.dataSdk = {
        async init(handler) {
          try {
            handlerRef = handler;

            const authed = await ensureAuth();
            if (!authed) return err("Auth failed (check Anonymous sign-in).");

            const db = firebase.firestore();

            if (unsubscribe) unsubscribe();
            unsubscribe = db.collection("reports").onSnapshot(
              (snap) => {
                const list = snap.docs.map(mapDoc);
                handlerRef?.onDataChanged?.(list);
              },
              (e) => console.error("onSnapshot error:", e)
            );

            return ok(true);
          } catch (e) {
            return err(e?.message || "init failed");
          }
        },

        async create(report) {
          try {
            const authed = await ensureAuth();
            if (!authed) return err("Auth failed");

            const db = firebase.firestore();
            const payload = { ...report };
            Object.keys(payload).forEach(k => payload[k] === undefined && delete payload[k]);

            const ref = await db.collection("reports").add(payload);
            return ok({ ...payload, __backendId: ref.id });
          } catch (e) {
            return err(e?.message || "create failed");
          }
        },

        async update(report) {
          try {
            const authed = await ensureAuth();
            if (!authed) return err("Auth failed");
            if (!report?.__backendId) return err("missing __backendId");

            const db = firebase.firestore();
            const id = report.__backendId;

            const payload = { ...report };
            delete payload.__backendId;
            Object.keys(payload).forEach(k => payload[k] === undefined && delete payload[k]);

            await db.collection("reports").doc(id).update(payload);
            return ok(true);
          } catch (e) {
            return err(e?.message || "update failed");
          }
        },

        async delete(id) {
          try {
            const authed = await ensureAuth();
            if (!authed) return err("Auth failed");
            if (!id) return err("missing id");

            const db = firebase.firestore();
            await db.collection("reports").doc(id).delete();
            return ok(true);
          } catch (e) {
            return err(e?.message || "delete failed");
          }
        }
      };
    })();

    document.addEventListener('DOMContentLoaded', () => {
      initApp();
      bindAddForm();
      // bindEditForm / bindStudentForm ‡πÄ‡∏õ‡πá‡∏ô IIFE ‡πÅ‡∏•‡πâ‡∏ß
    });

    // ============================================
    // UPDATE STATS
    // ============================================
    function updateStats() {
      const total = allReports.length;
      const uniqueStudents = new Set(allReports.map(r => r.student_id)).size;

      const ready = allReports.filter(r => normalizeStatus(r.status) === 'READY TO JOIN SHIP').length;
      const onboard = allReports.filter(r => normalizeStatus(r.status) === 'ON BOARD').length;
      const onleave = allReports.filter(r => isOnLeaveStatus(r.status)).length;

      if (document.getElementById('stat-total')) document.getElementById('stat-total').textContent = total;
      if (document.getElementById('stat-students')) document.getElementById('stat-students').textContent = uniqueStudents;
      if (document.getElementById('stat-standby')) document.getElementById('stat-standby').textContent = ready;
      if (document.getElementById('stat-onboard')) document.getElementById('stat-onboard').textContent = onboard;
      if (document.getElementById('stat-onleave')) document.getElementById('stat-onleave').textContent = onleave;
    }

    // ============================================
    // ‚úÖ NEW: FILTER SNAPSHOT (‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á+export+insights)
    // ============================================
    function getFilteredReportsSnapshot() {
      const filterYear = document.getElementById('filter-year');
      const searchInput = document.getElementById('search-input');

      const yearFilter = filterYear ? filterYear.value : 'all';
      const searchTerm = searchInput ? (searchInput.value || '').toLowerCase() : '';

      let filteredReports = allReports.slice();

      if (yearFilter !== 'all') {
        filteredReports = filteredReports.filter(r => r.academic_year === yearFilter);
      }

      if (searchTerm) {
        filteredReports = filteredReports.filter(r =>
          (r.student_id || '').toLowerCase().includes(searchTerm) ||
          (r.student_name || '').toLowerCase().includes(searchTerm) ||
          (r.ship_name || '').toLowerCase().includes(searchTerm) ||
          (r.company_name || '').toLowerCase().includes(searchTerm)
        );
      }

      filteredReports = filteredReports.sort((a, b) => {
        if (a.student_id !== b.student_id) return (a.student_id || '').localeCompare((b.student_id || ''));
        if (a.academic_year !== b.academic_year) return (b.academic_year || '').localeCompare((a.academic_year || ''));
        return (b.trip_seq || 0) - (a.trip_seq || 0);
      });

      return { yearFilter, searchTerm, filteredReports };
    }

    // ============================================
    // ‚úÖ NEW: EXPORT MODAL + EXPORTERS
    // ============================================
    function openExportModal() {
      document.getElementById('export-modal')?.classList.remove('hidden');
    }
    function closeExportModal() {
      document.getElementById('export-modal')?.classList.add('hidden');
    }

    function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function toCSV(rows, headers) {
      const esc = (v) => {
        const s = (v ?? '').toString().replace(/\r?\n/g, ' ').trim().replace(/"/g, '""');
        return `"${s}"`;
      };
      return [
        headers.join(','),
        ...rows.map(r => headers.map(h => esc(r[h])).join(','))
      ].join('\n');
    }

    function exportReportsCSV() {
      const snap = getFilteredReportsSnapshot();
      const rows = snap.filteredReports;
      if (!rows.length) return showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ Export', 'error');

      const headers = [
        'student_id','student_name','academic_year','department','trip_seq','trip_number',
        'boarding_date','return_date','join_date','leave_date',
        'ship_name','company_name','status','notes','work_details',
        'trip_id','submitted_at','__backendId'
      ];

      const csv = toCSV(rows, headers);
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      downloadBlob(blob, `reports_${new Date().toISOString().slice(0,10)}.csv`);
      showToast('Export ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (CSV) ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    }

    function exportReportsXLSX() {
      const snap = getFilteredReportsSnapshot();
      const rows = snap.filteredReports;
      if (!rows.length) return showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ Export', 'error');

      if (typeof XLSX === 'undefined') {
        showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö XLSX library ‚Üí Export ‡πÄ‡∏õ‡πá‡∏ô CSV ‡πÅ‡∏ó‡∏ô', 'error');
        return exportReportsCSV();
      }

      const data = rows.map(r => ({
        student_id: r.student_id || '',
        student_name: r.student_name || '',
        academic_year: r.academic_year || '',
        department: r.department || '',
        trip_seq: r.trip_seq || 1,
        trip_number: r.trip_number ?? '',
        boarding_date: r.boarding_date || '',
        return_date: r.return_date || '',
        join_date: r.join_date || '',
        leave_date: r.leave_date || '',
        ship_name: r.ship_name || '',
        company_name: r.company_name || '',
        status: normalizeStatus(r.status),
        notes: r.notes || '',
        work_details: r.work_details || '',
        trip_id: r.trip_id || '',
        submitted_at: r.submitted_at || '',
        backend_id: r.__backendId || ''
      }));

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Reports');
      const out = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });

      downloadBlob(
        new Blob([out], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }),
        `reports_${new Date().toISOString().slice(0,10)}.xlsx`
      );
      showToast('Export ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (Excel) ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    }

    function getAllStudentsMergedForExport() {
      const list = [];

      // base studentDatabase
      for (const [dept, years] of Object.entries(studentDatabase || {})) {
        for (const [year, map] of Object.entries(years || {})) {
          for (const info of Object.values(map || {})) {
            list.push({
              academic_year: String(year),
              department: String(dept),
              id: String(info.id || ''),
              fullName: String(info.fullName || '')
            });
          }
        }
      }

      // Firestore students
      (allStudents || []).forEach(s => {
        list.push({
          academic_year: String(s.academic_year || ''),
          department: String(s.department || ''),
          id: String(s.id || ''),
          fullName: String(s.fullName || '')
        });
      });

      // dedupe year|dept|id
      const seen = new Set();
      const merged = list.filter(s => {
        const key = `${s.academic_year}|${s.department}|${s.id}`;
        if (!s.academic_year || !s.department || !s.id) return false;
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      });

      merged.sort((a, b) =>
        a.academic_year.localeCompare(b.academic_year) ||
        a.department.localeCompare(b.department) ||
        a.id.localeCompare(b.id)
      );

      return merged;
    }

    function exportStudentsCSV() {
      const rows = getAllStudentsMergedForExport();
      if (!rows.length) return showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏´‡πâ Export', 'error');

      const headers = ['academic_year','department','id','fullName'];
      const csv = toCSV(rows, headers);
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      downloadBlob(blob, `students_${new Date().toISOString().slice(0,10)}.csv`);
      showToast('Export ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (CSV) ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    }

    function exportStudentsXLSX() {
      const rows = getAllStudentsMergedForExport();
      if (!rows.length) return showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏´‡πâ Export', 'error');

      if (typeof XLSX === 'undefined') {
        showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö XLSX library ‚Üí Export ‡πÄ‡∏õ‡πá‡∏ô CSV ‡πÅ‡∏ó‡∏ô', 'error');
        return exportStudentsCSV();
      }

      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Students');
      const out = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });

      downloadBlob(
        new Blob([out], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }),
        `students_${new Date().toISOString().slice(0,10)}.xlsx`
      );
      showToast('Export ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (Excel) ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    }

    // ============================================
    // ‚úÖ NEW: DASHBOARD INSIGHTS (‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á‡∏î‡πâ‡∏ß‡∏¢ div)
    // ============================================
    function renderInsightsBars(targetId, items, total, mode = 'percent') {
      const el = document.getElementById(targetId);
      if (!el) return;

      if (!items.length || total <= 0) {
        el.innerHTML = `<div class="text-sm text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
        return;
      }

      el.innerHTML = items.map(it => {
        const value = it.value || 0;
        const pct = total ? (value / total * 100) : 0;
        const w = Math.max(0, Math.min(100, pct));
        const rightText = (mode === 'count') ? `${value}` : `${pct.toFixed(1)}% (${value})`;

        return `
          <div class="space-y-1">
            <div class="flex items-center justify-between gap-2">
              <div class="text-xs font-semibold text-gray-700 truncate">${escapeHtml(it.label)}</div>
              <div class="text-xs font-bold text-gray-800 whitespace-nowrap">${rightText}</div>
            </div>
            <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
              <div class="h-2 bg-indigo-500 rounded-full" style="width:${w}%"></div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderDashboardInsights() {
      const updated = document.getElementById('insights-updated');
      if (updated) {
        updated.textContent = new Date().toLocaleString('th-TH', { hour: '2-digit', minute: '2-digit' });
      }

      const snap = getFilteredReportsSnapshot();
      const reps = snap.filteredReports || [];
      const totalTrips = reps.length;

      // Status distribution
      const statusCount = {};
      reps.forEach(r => {
        const s = normalizeStatus(r.status);
        statusCount[s] = (statusCount[s] || 0) + 1;
      });

      const statusItems = Object.entries(statusCount)
        .map(([label, value]) => ({ label, value }))
        .sort((a, b) => b.value - a.value);

      renderInsightsBars('insights-status', statusItems, totalTrips, 'percent');

      // Academic year distribution
      const yearCount = {};
      reps.forEach(r => {
        const y = (r.academic_year || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏µ').trim() || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏µ';
        yearCount[y] = (yearCount[y] || 0) + 1;
      });

      const yearItems = Object.entries(yearCount)
        .map(([label, value]) => ({ label, value }))
        .sort((a, b) => (a.label || '').localeCompare(b.label || ''));

      renderInsightsBars('insights-year', yearItems, totalTrips, 'count');

      // Top companies (within filtered)
      const companyCount = {};
      reps.forEach(r => {
        const c = (r.company_name || '').trim();
        if (!c) return;
        companyCount[c] = (companyCount[c] || 0) + 1;
      });

      const companyItems = Object.entries(companyCount)
        .map(([label, value]) => ({ label, value }))
        .sort((a, b) => b.value - a.value)
        .slice(0, 10);

      const companyTotal = companyItems.reduce((s, x) => s + x.value, 0) || 0;
      renderInsightsBars('insights-company', companyItems, companyTotal, 'count');
    }

    // ============================================
    // RENDER TABLE (‚úÖ PAGINATION)
    // ============================================
    function renderTable() {
      const tbody = document.getElementById('report-table-body');
      const emptyState = document.getElementById('empty-state');
      const filterCount = document.getElementById('filter-count');
      if (!tbody) return;

      const snap = getFilteredReportsSnapshot();
      let filteredReports = snap.filteredReports;

      // ‚úÖ reset page ‡∏ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á/‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
      const key = `${snap.yearFilter}|${snap.searchTerm}|${pagination.pageSize}`;
      if (pagination.lastKey !== key) {
        pagination.lastKey = key;
        pagination.page = 1;
      }

      const total = filteredReports.length;
      const totalPages = Math.max(1, Math.ceil(total / pagination.pageSize));
      pagination.page = Math.max(1, Math.min(pagination.page, totalPages));

      const startIndex0 = (pagination.page - 1) * pagination.pageSize;
      const endIndex0 = Math.min(startIndex0 + pagination.pageSize, total);
      const pageReports = filteredReports.slice(startIndex0, endIndex0);

      if (filterCount) {
        if (total === 0) filterCount.textContent = `‡πÅ‡∏™‡∏î‡∏á 0 ‡∏à‡∏≤‡∏Å ${allReports.length} ‡∏ó‡∏£‡∏¥‡∏õ`;
        else filterCount.textContent = `‡πÅ‡∏™‡∏î‡∏á ${startIndex0 + 1}-${endIndex0} ‡∏à‡∏≤‡∏Å ${total} ‡∏ó‡∏£‡∏¥‡∏õ (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${allReports.length})`;
      }

      if (total === 0) {
        tbody.innerHTML = '';
        if (emptyState) emptyState.classList.remove('hidden');
        updatePaginationBar(0, 1, 0, 0);
        renderDashboardInsights();
        return;
      } else {
        if (emptyState) emptyState.classList.add('hidden');
      }

      tbody.innerHTML = pageReports.map(report => {
        const displayStatus = normalizeStatus(report.status);

        return `
          <tr class="table-row" data-backend-id="${report.__backendId}">
            <td class="px-4 py-4 text-sm text-gray-900 font-medium">${escapeHtml(report.student_id || '')}</td>
            <td class="px-4 py-4 text-sm text-gray-900">${escapeHtml(report.student_name || '')}</td>
            <td class="px-4 py-4 text-sm">
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                Trip #${report.trip_seq || 1}
              </span>
            </td>
            <td class="px-4 py-4 text-sm text-gray-600">${escapeHtml(String(report.trip_number ?? '-'))}</td>
            <td class="px-4 py-4 text-sm text-gray-600">${escapeHtml(report.academic_year || '')}</td>
            <td class="px-4 py-4 text-sm text-gray-600">${escapeHtml(report.department || '')}</td>
            <td class="px-4 py-4 text-sm text-gray-600">
              ${formatDateThai(report.boarding_date)} - ${formatDateThai(report.return_date)}
            </td>
            <td class="px-4 py-4 text-sm text-gray-600">${escapeHtml(report.ship_name || '')}</td>
            <td class="px-4 py-4 text-sm text-gray-600">${escapeHtml(report.company_name || '')}</td>
            <td class="px-4 py-4">
              <select onchange="updateStatus('${report.__backendId}', this.value)"
                      class="px-3 py-1.5 rounded-lg text-sm font-medium border-0 cursor-pointer ${getStatusColorClass(displayStatus)}">
                <option value="NO REQUEST TO JOIN THE SHIP" ${displayStatus === 'NO REQUEST TO JOIN THE SHIP' ? 'selected' : ''}>üö´ NO REQUEST TO JOIN THE SHIP</option>
                <option value="THE VOYAGE PROCESS" ${displayStatus === 'THE VOYAGE PROCESS' ? 'selected' : ''}>üåä THE VOYAGE PROCESS</option>
                <option value="READY TO JOIN SHIP" ${displayStatus === 'READY TO JOIN SHIP' ? 'selected' : ''}>‚è≥ READY TO JOIN SHIP</option>
                <option value="ON BOARD" ${displayStatus === 'ON BOARD' ? 'selected' : ''}>‚úÖ ON BOARD</option>
                <option value="ON LEAVE - APPLY FOR GRADUATION" ${displayStatus === 'ON LEAVE - APPLY FOR GRADUATION' ? 'selected' : ''}>üéì ON LEAVE - APPLY FOR GRADUATION</option>
                <option value="ON LEAVE - WAIT FOR GRADUATION PROCESS" ${displayStatus === 'ON LEAVE - WAIT FOR GRADUATION PROCESS' ? 'selected' : ''}>‚è≥üéì ON LEAVE - WAIT FOR GRADUATION PROCESS</option>
                <option value="ON LEAVE - OWN BUSINESS" ${displayStatus === 'ON LEAVE - OWN BUSINESS' ? 'selected' : ''}>üíº ON LEAVE - OWN BUSINESS</option>
                <option value="ON LEAVE - WAIT FOR REJOIN" ${displayStatus === 'ON LEAVE - WAIT FOR REJOIN' ? 'selected' : ''}>‚è∏Ô∏è ON LEAVE - WAIT FOR REJOIN</option>
                <option value="GRADUATED" ${displayStatus === 'GRADUATED' ? 'selected' : ''}>üéâ GRADUATED</option>
              </select>
            </td>
            <td class="px-4 py-4 text-sm text-gray-600">${escapeHtml(report.notes || '-')}</td>
            <td class="px-4 py-4 text-sm">
              <div class="flex gap-2">
                <button onclick="openEditModal('${report.__backendId}')"
                        class="px-3 py-2 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 font-medium">
                  ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                </button>
                <button onclick="deleteReport('${report.__backendId}')"
                        class="px-3 py-2 rounded-lg bg-red-100 text-red-700 hover:bg-red-200 font-medium">
                  üóëÔ∏è ‡∏•‡∏ö
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      updatePaginationBar(total, totalPages, startIndex0 + 1, endIndex0);
      renderDashboardInsights(); // ‚úÖ NEW: insights follow filters/search
    }

    // ============================================
    // HIGHLIGHT DUPLICATE
    // ============================================
    function highlightDuplicateInTable(backendId) {
      const row = document.querySelector(`tr[data-backend-id="${backendId}"]`);
      if (row) {
        row.classList.add('highlight-duplicate');
        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => row.classList.remove('highlight-duplicate'), 3000);
      }
    }

    // ============================================
    // EDIT / DELETE
    // ============================================
    let editingBackendId = null;

    function openEditModal(backendId) {
      const report = allReports.find(r => r.__backendId === backendId);
      if (!report) return;

      editingBackendId = backendId;

      const setVal = (id, val) => {
        const el = document.getElementById(id);
        if (el) el.value = val ?? '';
      };

      setVal('edit-student-id', report.student_id || '');
      setVal('edit-student-name', report.student_name || '');
      setVal('edit-academic-year', report.academic_year || '');
      setVal('edit-department', report.department || '');
      setVal('edit-trip-seq', String(report.trip_seq ?? ''));
      setVal('edit-trip-id', report.trip_id || '');
      setVal('edit-submitted-at', report.submitted_at || '');

      setVal('edit-boarding-date', report.boarding_date || '');
      setVal('edit-return-date', report.return_date || '');
      setVal('edit-join-date', report.join_date || '');
      setVal('edit-leave-date', report.leave_date || '');
      setVal('edit-ship-name', report.ship_name || '');
      setVal('edit-company-name', report.company_name || '');
      setVal('edit-trip-number', String(report.trip_number ?? 1));
      setVal('edit-work-details', report.work_details || '');
      setVal('edit-notes', report.notes || '');

      const st = normalizeStatus(report.status);
      const statusEl = document.getElementById('edit-status');
      if (statusEl) statusEl.value = st;

      document.getElementById('edit-modal').classList.remove('hidden');
    }

    function closeEditModal() {
      editingBackendId = null;
      document.getElementById('edit-modal').classList.add('hidden');
    }

    async function deleteReport(backendId) {
      const report = allReports.find(r => r.__backendId === backendId);
      if (!report) return;

      const okConfirm = confirm(
        `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?\n` +
        `${report.student_id || ''} ${report.student_name || ''}\n` +
        `‡πÄ‡∏£‡∏∑‡∏≠: ${report.ship_name || '-'}\n` +
        `‡∏ä‡πà‡∏ß‡∏á: ${report.boarding_date || '-'} ‡∏ñ‡∏∂‡∏á ${report.return_date || '-'}\n\n` +
        `*‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ*`
      );
      if (!okConfirm) return;

      const delFn = window.dataSdk?.delete;
      if (!delFn) return showToast('‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');

      const result = await delFn.call(window.dataSdk, backendId);
      if (result?.isOk) showToast('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
      else {
        showToast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error');
        console.error('Delete error:', result?.error);
      }
    }

    (function bindEditForm() {
      const ef = document.getElementById('edit-form');
      if (!ef) {
        document.addEventListener('DOMContentLoaded', bindEditForm, { once: true });
        return;
      }
      if (ef.__bound) return;
      ef.__bound = true;

      ef.addEventListener('submit', async function (e) {
        e.preventDefault();
        if (!editingBackendId) return;

        const old = allReports.find(r => r.__backendId === editingBackendId);
        if (!old) return;

        const boarding = document.getElementById('edit-boarding-date').value;
        const ret = document.getElementById('edit-return-date').value;

        if (!boarding || !ret) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'error');
        if (new Date(ret) < new Date(boarding)) return showToast('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏•‡∏±‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏•‡∏á‡πÄ‡∏£‡∏∑‡∏≠', 'error');

        const updated = {
          ...old,
          boarding_date: boarding,
          return_date: ret,

          // ‚úÖ ‡πÅ‡∏Å‡πâ‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏î‡πâ
          department: (document.getElementById('edit-department').value || old.department || '').trim(),

          join_date: document.getElementById('edit-join-date').value || '',
          leave_date: document.getElementById('edit-leave-date').value || '',
          ship_name: document.getElementById('edit-ship-name').value || '',
          company_name: document.getElementById('edit-company-name').value || '',
          trip_number: parseInt(document.getElementById('edit-trip-number').value) || 1,
          work_details: document.getElementById('edit-work-details').value || '',
          notes: document.getElementById('edit-notes').value || '',
          status: normalizeStatus(document.getElementById('edit-status').value || old.status)
        };

        const dup = allReports.find(r =>
          r.__backendId !== updated.__backendId &&
          r.student_id === updated.student_id &&
          r.academic_year === updated.academic_year &&
          r.ship_name === updated.ship_name &&
          r.boarding_date === updated.boarding_date &&
          r.return_date === updated.return_date
        );
        if (dup) {
          showToast('‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö', 'error');
          highlightDuplicateInTable(dup.__backendId);
          return;
        }

        const overlaps = allReports
          .filter(r => r.__backendId !== updated.__backendId)
          .filter(r => r.student_id === updated.student_id && r.academic_year === updated.academic_year)
          .filter(r => isDateOverlap(updated.boarding_date, updated.return_date, r.boarding_date, r.return_date));

        if (overlaps.length > 0) {
          const okOverlap = confirm('‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç "‡∏ó‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô" ‡∏Å‡∏±‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏ô‡∏õ‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡πà‡∏≠‡πÑ‡∏´‡∏°?');
          if (!okOverlap) return;
        }

        const result = await window.dataSdk.update(updated);
        if (result?.isOk) {
          showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
          closeEditModal();
        } else {
          showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
          console.error('Edit error:', result?.error);
        }
      });
    })();

    async function updateStatus(backendId, newStatus) {
      const report = allReports.find(r => r.__backendId === backendId);
      if (!report) return;

      const updatedReport = { ...report, status: normalizeStatus(newStatus) };

      if (window.dataSdk) {
        const result = await window.dataSdk.update(updatedReport);
        if (result?.isOk) showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        else showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error');
      }
    }

    // ============================================
    // MODAL FUNCTIONS
    // ============================================
    function openAddModal() {
      const modal = document.getElementById('add-modal');
      if (modal) {
        modal.classList.remove('hidden');
        resetAddForm();
      }
    }

    function closeAddModal() {
      const modal = document.getElementById('add-modal');
      if (modal) {
        modal.classList.add('hidden');
        resetAddForm();
      }
      pendingTripData = null;
      pendingOverlapConfirmed = false;
    }

    function resetAddForm() {
      const form = document.getElementById('add-form');
      if (form) form.reset();

      const studentSelect = document.getElementById('form-student-select');
      if (studentSelect) {
        studentSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Å‡πà‡∏≠‡∏ô --</option>';
        studentSelect.disabled = true;
      }

      ['form-student-id', 'form-student-name', 'form-department'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });

      const historyDisplay = document.getElementById('trip-history-display');
      if (historyDisplay) historyDisplay.innerHTML = '';
    }

    function updateStudentDropdown() {
      const yearSelect = document.getElementById('form-academic-year');
      const studentSelect = document.getElementById('form-student-select');

      if (!yearSelect || !studentSelect) return;

      const year = yearSelect.value;

      if (!year) {
        studentSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Å‡πà‡∏≠‡∏ô --</option>';
        studentSelect.disabled = true;
        clearStudentInfo();
        return;
      }

      let options = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ --</option>';
      const list = (window.getStudentsForYear ? window.getStudentsForYear(year) : []);

      list.forEach(s => {
        options += `<option value="${s.department}|${s.id}|${s.fullName}">
          ${s.id} - ${s.fullName} (${s.department})
        </option>`;
      });

      studentSelect.innerHTML = options;
      studentSelect.disabled = false;
      clearStudentInfo();
    }

    function fillStudentInfo() {
      const studentSelect = document.getElementById('form-student-select');
      if (!studentSelect || !studentSelect.value) {
        clearStudentInfo();
        return;
      }

      const [dept, id, fullName] = studentSelect.value.split('|');

      const idField = document.getElementById('form-student-id');
      const nameField = document.getElementById('form-student-name');
      const deptField = document.getElementById('form-department');

      if (idField) idField.value = id;
      if (nameField) nameField.value = fullName;
      if (deptField) deptField.value = dept;

      const recentTrips = getRecentTrips(allReports, id, 3);
      const historyContainer = document.getElementById('trip-history-display');

      if (historyContainer) {
        if (recentTrips.length === 0) {
          historyContainer.innerHTML = `
            <div class="bg-blue-50 rounded-lg p-3 text-sm text-gray-600">
              ‚ÑπÔ∏è ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
            </div>
          `;
        } else {
          historyContainer.innerHTML = `
            <div class="bg-green-50 rounded-lg p-4 space-y-2">
              <p class="text-sm font-semibold text-gray-700 mb-2">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏£‡∏¥‡∏õ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</p>
              ${recentTrips.map(trip => {
                const st = normalizeStatus(trip.status);
                return `
                  <div class="text-xs text-gray-600 border-l-2 border-green-400 pl-2">
                    <strong>Trip #${trip.trip_seq}</strong> |
                    ${escapeHtml(trip.ship_name)} |
                    ${formatDateThai(trip.boarding_date)} - ${formatDateThai(trip.return_date)} |
                    <span class="px-2 py-0.5 rounded text-xs ${getStatusColorClass(st)}">${st}</span>
                  </div>
                `;
              }).join('')}
            </div>
          `;
        }
      }
    }

    function clearStudentInfo() {
      ['form-student-id', 'form-student-name', 'form-department'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });

      const historyDisplay = document.getElementById('trip-history-display');
      if (historyDisplay) historyDisplay.innerHTML = '';
    }

    // ============================================
    // OVERLAP WARNING MODAL
    // ============================================
    function showOverlapWarning(overlappingTrips, newTripData) {
      const existingModal = document.getElementById('overlap-warning-modal');
      if (existingModal) existingModal.remove();

      const modal = document.createElement('div');
      modal.id = 'overlap-warning-modal';
      modal.className = 'fixed inset-0 z-50 flex items-center justify-center';
      modal.innerHTML = `
        <div class="modal-overlay absolute inset-0"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 m-4">
          <div class="flex items-start gap-4 mb-4">
            <div class="w-12 h-12 rounded-full bg-yellow-100 flex items-center justify-center flex-shrink-0">
              <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
              </svg>
            </div>
            <div class="flex-1">
              <h3 class="text-lg font-bold text-gray-900 mb-2">‚ö†Ô∏è ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏£‡∏¥‡∏õ‡∏ó‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô</h3>
              <p class="text-gray-600 text-sm mb-3">
                ‡∏ó‡∏£‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà (${formatDateThai(newTripData.boarding_date)} - ${formatDateThai(newTripData.return_date)})
                ‡∏°‡∏µ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡∏ö‡∏Å‡∏±‡∏ö‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏î‡∏¥‡∏°:
              </p>
              <div class="bg-red-50 rounded-lg p-3 space-y-2 mb-4">
                ${overlappingTrips.map(trip => `
                  <div class="text-sm text-red-700">
                    üö¢ Trip #${trip.trip_seq}: ${escapeHtml(trip.ship_name)}<br>
                    üìÖ ${formatDateThai(trip.boarding_date)} - ${formatDateThai(trip.return_date)}
                  </div>
                `).join('<hr class="border-red-200">')}
              </div>
            </div>
          </div>

          <div class="flex gap-3">
            <button onclick="cancelOverlapSubmit()"
              class="flex-1 px-4 py-2 rounded-xl border border-gray-300 text-gray-700 font-medium hover:bg-gray-50">
              ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
            </button>
            <button onclick="confirmOverlapSubmit()"
              class="flex-1 px-4 py-2 rounded-xl btn-warning text-white font-medium">
              ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      pendingTripData = newTripData;
      pendingOverlapConfirmed = false;
    }

    function cancelOverlapSubmit() {
      const modal = document.getElementById('overlap-warning-modal');
      if (modal) modal.remove();
      pendingTripData = null;
      pendingOverlapConfirmed = false;
    }

    function confirmOverlapSubmit() {
      pendingOverlapConfirmed = true;
      const modal = document.getElementById('overlap-warning-modal');
      if (modal) modal.remove();
      if (pendingTripData) submitTrip(pendingTripData);
    }

    // ============================================
    // FORM SUBMISSION
    // ============================================
    function bindAddForm() {
      const f = document.getElementById('add-form');
      if (!f || f.__bound) return;
      f.__bound = true;

      f.addEventListener('submit', async function (e) {
        e.preventDefault();
        if (isSubmitting) return;

        const studentId = document.getElementById('form-student-id').value;
        const studentName = document.getElementById('form-student-name').value;
        const academicYear = document.getElementById('form-academic-year').value;
        const department = document.getElementById('form-department').value;
        const boardingDate = document.getElementById('form-boarding-date').value;
        const returnDate = document.getElementById('form-return-date').value;

        if (!studentId || !studentName || !academicYear || !department) {
          showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤', 'error');
          return;
        }

        if (!boardingDate || !returnDate) {
          showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏•‡∏±‡∏ö', 'error');
          return;
        }

        if (new Date(returnDate) < new Date(boardingDate)) {
          showToast('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏•‡∏±‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏•‡∏á‡πÄ‡∏£‡∏∑‡∏≠', 'error');
          return;
        }

        const formData = {
          student_id: studentId,
          student_name: studentName,
          academic_year: academicYear,
          department: department,
          boarding_date: boardingDate,
          return_date: returnDate,
          join_date: document.getElementById('form-join-date').value || '',
          ship_name: document.getElementById('form-ship-name').value || '',
          company_name: document.getElementById('form-company-name').value || '',
          leave_date: document.getElementById('form-leave-date').value || '',
          trip_number: parseInt(document.getElementById('form-trip-number').value) || 1,
          work_details: document.getElementById('form-work-details').value || '',
          notes: document.getElementById('form-notes').value || '',
          status: 'READY TO JOIN SHIP',
          submitted_at: new Date().toISOString()
        };

        const duplicate = duplicateCheck(allReports, formData);
        if (duplicate) {
          showToast('‡∏°‡∏µ‡∏ó‡∏£‡∏¥‡∏õ‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', 'error');
          highlightDuplicateInTable(duplicate.__backendId);
          return;
        }

        const overlapping = findOverlappingTrips(allReports, formData);
        if (overlapping.length > 0 && !pendingOverlapConfirmed) {
          showOverlapWarning(overlapping, formData);
          return;
        }

        await submitTrip(formData);
      });
    }

    async function submitTrip(formData) {
      if (allReports.length >= 999) {
        showToast('‡∏ñ‡∏∂‡∏á‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î 999 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå', 'error');
        return;
      }

      formData.trip_seq = computeNextTripSeq(allReports, formData.student_id, formData.academic_year);
      formData.trip_id = buildTripId(formData);
      formData.status = normalizeStatus(formData.status);

      isSubmitting = true;
      const submitBtn = document.getElementById('submit-btn');
      const submitText = document.getElementById('submit-text');
      const submitSpinner = document.getElementById('submit-spinner');

      if (submitBtn) submitBtn.disabled = true;
      if (submitText) submitText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      if (submitSpinner) submitSpinner.classList.remove('hidden');

      if (window.dataSdk) {
        const result = await window.dataSdk.create(formData);
        if (result.isOk) {
          showToast(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Trip #${formData.trip_seq} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, 'success');
          closeAddModal();
        } else {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
          console.error('Data SDK Error:', result.error);
        }
      }

      isSubmitting = false;
      if (submitBtn) submitBtn.disabled = false;
      if (submitText) submitText.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
      if (submitSpinner) submitSpinner.classList.add('hidden');

      pendingTripData = null;
      pendingOverlapConfirmed = false;
    }

    // ============================================
    // SUMMARY MODAL / SUMMARY PAGE
    // ============================================
    function openSummaryModal() {
      const modal = document.getElementById('summary-modal');
      if (modal) {
        modal.classList.remove('hidden');
        updateSummary();
      }
    }

    function closeSummaryModal() {
      const modal = document.getElementById('summary-modal');
      if (modal) modal.classList.add('hidden');
    }

    // ‚úÖ NEW: Summary Page Open/Close (‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô)
    function openSummaryPage() {
      const dash = document.getElementById('dashboard-page');
      const page = document.getElementById('summary-page');
      if (dash) dash.classList.add('hidden');
      if (page) page.classList.remove('hidden');
      updateSummaryPage();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function closeSummaryPage() {
      const dash = document.getElementById('dashboard-page');
      const page = document.getElementById('summary-page');
      if (page) page.classList.add('hidden');
      if (dash) dash.classList.remove('hidden');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function safeParseDate(dateStr) {
      if (!dateStr) return null;
      const d = new Date(dateStr);
      if (isNaN(d.getTime())) return null;
      return d;
    }

    function countStatuses(reports) {
      const base = {
        total: 0,
        STANDBYFORSHIP: 0,
        ON_LEAVE_TOTAL: 0,
        GRADUATION: 0,
        UNKNOWN: 0
      };

      (ALLOWED_STATUSES || []).forEach(s => { base[s] = 0; });

      reports.forEach(r => {
        base.total++;
        const s = normalizeStatus(r.status);
        if (base[s] !== undefined) base[s]++;
        else base.UNKNOWN++;
      });

      base.STANDBYFORSHIP = base['READY TO JOIN SHIP'] || 0;

      base.ON_LEAVE_TOTAL =
        (base['ON LEAVE - APPLY FOR GRADUATION'] || 0) +
        (base['ON LEAVE - WAIT FOR GRADUATION PROCESS'] || 0) +
        (base['ON LEAVE - WAIT FOR REJOIN'] || 0) +
        (base['ON LEAVE - OWN BUSINESS'] || 0);

      base.GRADUATION = base['GRADUATED'] || 0;

      return base;
    }

    function renderBreakdownTable(groupCounts, groupLabel) {
      const rows = Object.entries(groupCounts);
      if (rows.length === 0) return `<p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>`;

      rows.sort((a, b) => (b[1].total || 0) - (a[1].total || 0));

      return `
        <table class="min-w-[860px] w-full text-sm">
          <thead>
            <tr class="bg-gray-50 text-gray-700">
              <th class="text-left px-3 py-2 font-semibold">${escapeHtml(groupLabel)}</th>
              <th class="text-right px-3 py-2 font-semibold">TOTAL</th>
              <th class="text-right px-3 py-2 font-semibold">STANDBYFORSHIP</th>
              <th class="text-right px-3 py-2 font-semibold">ON BOARD</th>
              <th class="text-right px-3 py-2 font-semibold">ON LEAVE (TOTAL)</th>
              <th class="text-right px-3 py-2 font-semibold">GRADUATION</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            ${rows.map(([key, c]) => `
              <tr>
                <td class="px-3 py-2 text-gray-800 font-medium">${escapeHtml(key)}</td>
                <td class="px-3 py-2 text-right text-gray-700">${c.total}</td>
                <td class="px-3 py-2 text-right text-gray-700">${c.STANDBYFORSHIP}</td>
                <td class="px-3 py-2 text-right text-gray-700">${c['ON BOARD']}</td>
                <td class="px-3 py-2 text-right text-gray-700">
                  <div class="font-semibold">${c.ON_LEAVE_TOTAL}</div>
                  <div class="text-xs text-gray-500 whitespace-nowrap">
                    GP ${c['ON LEAVE - APPLY FOR GRADUATION'] || 0} /
                    WG ${c['ON LEAVE - WAIT FOR GRADUATION PROCESS'] || 0} /
                    WR ${c['ON LEAVE - WAIT FOR REJOIN'] || 0} /
                    OB ${c['ON LEAVE - OWN BUSINESS'] || 0}
                  </div>
                </td>
                <td class="px-3 py-2 text-right text-gray-700">${c.GRADUATION}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function updateSummary() {
      const summaryDate = document.getElementById('summary-date');
      if (summaryDate) {
        summaryDate.textContent = new Date().toLocaleDateString('th-TH', {
          year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
        });
      }

      const overallEl = document.getElementById('summary-overall');
      const topEl = document.getElementById('summary-top-insights');
      const deptEl = document.getElementById('summary-by-department');
      const yearEl = document.getElementById('summary-by-year');
      const warnEl = document.getElementById('summary-warnings');

      renderSummaryToTargets({ overallEl, topEl, deptEl, yearEl, warnEl });
    }

    function updateSummaryPage() {
      const summaryDate = document.getElementById('summary-date-page');
      if (summaryDate) {
        summaryDate.textContent = new Date().toLocaleDateString('th-TH', {
          year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
        });
      }

      const overallEl = document.getElementById('summary-overall-page');
      const topEl = document.getElementById('summary-top-insights-page');
      const deptEl = document.getElementById('summary-by-department-page');
      const yearEl = document.getElementById('summary-by-year-page');
      const warnEl = document.getElementById('summary-warnings-page');

      renderSummaryToTargets({ overallEl, topEl, deptEl, yearEl, warnEl });
    }

    function renderSummaryToTargets({ overallEl, topEl, deptEl, yearEl, warnEl }) {
      const overallCounts = countStatuses(allReports);
      const uniqueStudents = new Set(allReports.map(r => r.student_id)).size;

      if (overallEl) {
        overallEl.innerHTML = `
          <h3 class="text-lg font-semibold text-gray-800 mb-4">üìå Overall Summary</h3>

          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
            <div class="bg-white/70 rounded-lg p-4 text-center border border-white">
              <p class="text-3xl font-bold text-indigo-600">${overallCounts.total}</p>
              <p class="text-xs text-gray-600">‡∏¢‡∏≠‡∏î‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</p>
            </div>
            <div class="bg-white/70 rounded-lg p-4 text-center border border-white">
              <p class="text-3xl font-bold text-teal-600">${uniqueStudents}</p>
              <p class="text-xs text-gray-600">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</p>
            </div>
            <div class="bg-white/70 rounded-lg p-4 text-center border border-white">
              <p class="text-3xl font-bold text-yellow-600">${overallCounts.STANDBYFORSHIP}</p>
              <p class="text-xs text-gray-600">STANDBYFORSHIP</p>
            </div>
            <div class="bg-white/70 rounded-lg p-4 text-center border border-white">
              <p class="text-3xl font-bold text-green-600">${overallCounts['ON BOARD']}</p>
              <p class="text-xs text-gray-600">ON BOARD</p>
            </div>
          </div>

          <div class="bg-white/70 rounded-lg p-4 border border-white">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 items-start lg:items-center">
              <div class="lg:col-span-3">
                <p class="text-sm font-semibold text-gray-800">ON LEAVE (TOTAL)</p>
                <p class="text-2xl font-bold text-purple-700">${overallCounts.ON_LEAVE_TOTAL}</p>
              </div>

              <div class="lg:col-span-6">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
                  <div class="bg-purple-100 text-purple-800 rounded-lg px-3 py-2 flex items-center justify-between gap-2">
                    <span class="min-w-0 truncate font-semibold">APPLY FOR GRADUATION </span>
                    <span class="font-bold">${overallCounts['ON LEAVE - APPLY FOR GRADUATION'] || 0}</span>
                  </div>

                  <div class="bg-violet-100 text-violet-800 rounded-lg px-3 py-2 flex items-center justify-between gap-2">
                    <span class="min-w-0 truncate font-semibold">WAIT GRAD</span>
                    <span class="font-bold">${overallCounts['ON LEAVE - WAIT FOR GRADUATION PROCESS'] || 0}</span>
                  </div>

                  <div class="bg-rose-100 text-rose-800 rounded-lg px-3 py-2 flex items-center justify-between gap-2">
                    <span class="min-w-0 truncate font-semibold">WAIT REJOIN</span>
                    <span class="font-bold">${overallCounts['ON LEAVE - WAIT FOR REJOIN'] || 0}</span>
                  </div>

                  <div class="bg-orange-100 text-orange-800 rounded-lg px-3 py-2 flex items-center justify-between gap-2">
                    <span class="min-w-0 truncate font-semibold">OWN BUSINESS</span>
                    <span class="font-bold">${overallCounts['ON LEAVE - OWN BUSINESS'] || 0}</span>
                  </div>
                </div>
              </div>

              <div class="lg:col-span-3 lg:text-right">
                <p class="text-sm font-semibold text-gray-800">GRADUATION</p>
                <p class="text-2xl font-bold text-gray-700">${overallCounts.GRADUATION}</p>
              </div>
            </div>
          </div>
        `;
      }

      if (topEl) {
        const companyCount = {};
        allReports.forEach(r => {
          const name = (r.company_name || '').trim();
          if (!name) return;
          companyCount[name] = (companyCount[name] || 0) + 1;
        });
        const topCompanies = Object.entries(companyCount).sort((a, b) => b[1] - a[1]).slice(0, 5);

        const shipCount = {};
        allReports.forEach(r => {
          const name = (r.ship_name || '').trim();
          if (!name) return;
          shipCount[name] = (shipCount[name] || 0) + 1;
        });
        const topShips = Object.entries(shipCount).sort((a, b) => b[1] - a[1]).slice(0, 5);

        const studentsMap = {};
        allReports.forEach(r => {
          const sid = r.student_id || '';
          if (!sid) return;
          if (!studentsMap[sid]) studentsMap[sid] = { id: sid, name: r.student_name || '', trips: [] };
          studentsMap[sid].trips.push(r);
          if (!studentsMap[sid].name && r.student_name) studentsMap[sid].name = r.student_name;
        });

        const multiTripTop = Object.values(studentsMap)
          .filter(s => s.trips.length > 1)
          .map(s => {
            let latest = s.trips[0];
            s.trips.forEach(t => {
              const d1 = safeParseDate(latest.boarding_date);
              const d2 = safeParseDate(t.boarding_date);
              const t1 = d1 ? d1.getTime() : -Infinity;
              const t2 = d2 ? d2.getTime() : -Infinity;
              if (t2 > t1) latest = t;
            });
            return {
              id: s.id,
              name: s.name || '',
              count: s.trips.length,
              latestStatus: normalizeStatus(latest.status),
              latestBoarding: latest.boarding_date || ''
            };
          })
          .sort((a, b) => b.count - a.count)
          .slice(0, 10);

        const totalTripsForPct = overallCounts.total || 0;
        const pctItems = [...(ALLOWED_STATUSES || []), 'UNKNOWN']
          .map(s => {
            const cnt = (s === 'UNKNOWN') ? (overallCounts.UNKNOWN || 0) : (overallCounts[s] || 0);
            const pct = totalTripsForPct ? (cnt / totalTripsForPct * 100) : 0;
            return { status: s, cnt, pct };
          })
          .sort((a, b) => b.pct - a.pct);

        topEl.innerHTML = `
          <h3 class="text-lg font-semibold text-gray-800 mb-4">üí° Top Insight</h3>

          <div class="bg-white rounded-lg p-4 border border-gray-200 mb-4">
            <p class="font-semibold text-gray-800 mb-2">üìà ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (%)</p>

            ${totalTripsForPct === 0 ? `
              <p class="text-gray-500 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
            ` : `
              <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                ${pctItems.map(it => `
                  <div class="flex items-center justify-between gap-3 bg-gray-50 rounded-lg p-2">
                    <span class="px-2 py-1 rounded text-xs font-semibold ${getStatusColorClass(it.status)}">
                      ${escapeHtml(it.status)}
                    </span>
                    <span class="text-sm font-bold text-gray-800">
                      ${it.pct.toFixed(1)}%
                      <span class="text-xs text-gray-500">(${it.cnt})</span>
                    </span>
                  </div>
                `).join('')}
              </div>
            `}
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
              <p class="font-semibold text-gray-800 mb-2">üè¢ Top 5 ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó (‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏£‡∏¥‡∏õ)</p>
              ${topCompanies.length === 0
                ? `<p class="text-gray-500 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>`
                : `<ol class="space-y-1 text-sm">
                    ${topCompanies.map(([name, cnt], idx) => `
                      <li class="flex justify-between">
                        <span class="text-gray-700">${idx + 1}. ${escapeHtml(name)}</span>
                        <span class="font-semibold text-indigo-600">${cnt}</span>
                      </li>
                    `).join('')}
                  </ol>`
              }
            </div>

            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
              <p class="font-semibold text-gray-800 mb-2">üö¢ Top 5 ‡πÄ‡∏£‡∏∑‡∏≠ (‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏£‡∏¥‡∏õ)</p>
              ${topShips.length === 0
                ? `<p class="text-gray-500 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>`
                : `<ol class="space-y-1 text-sm">
                    ${topShips.map(([name, cnt], idx) => `
                      <li class="flex justify-between">
                        <span class="text-gray-700">${idx + 1}. ${escapeHtml(name)}</span>
                        <span class="font-semibold text-teal-600">${cnt}</span>
                      </li>
                    `).join('')}
                  </ol>`
              }
            </div>
          </div>

          <div class="bg-white rounded-lg p-4 border border-gray-200">
            <p class="font-semibold text-gray-800 mb-2">üîÑ ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏ó‡∏£‡∏¥‡∏õ (Top 10) + ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>
            ${multiTripTop.length === 0 ? `<p class="text-gray-500 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>` : `
              <div class="overflow-x-auto">
                <table class="min-w-[760px] w-full text-sm">
                  <thead>
                    <tr class="bg-gray-50 text-gray-700">
                      <th class="text-left px-3 py-2 font-semibold">‡∏£‡∏´‡∏±‡∏™</th>
                      <th class="text-left px-3 py-2 font-semibold">‡∏ä‡∏∑‡πà‡∏≠</th>
                      <th class="text-right px-3 py-2 font-semibold">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏£‡∏¥‡∏õ</th>
                      <th class="text-left px-3 py-2 font-semibold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                      <th class="text-left px-3 py-2 font-semibold">Boarding ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-100">
                    ${multiTripTop.map(s => `
                      <tr>
                        <td class="px-3 py-2 text-gray-800 font-medium">${escapeHtml(s.id)}</td>
                        <td class="px-3 py-2 text-gray-700">${escapeHtml(s.name)}</td>
                        <td class="px-3 py-2 text-right font-semibold text-purple-700">${s.count}</td>
                        <td class="px-3 py-2">
                          <span class="px-2 py-1 rounded text-xs ${getStatusColorClass(s.latestStatus)}">${s.latestStatus}</span>
                        </td>
                        <td class="px-3 py-2 text-gray-600">${formatDateThai(s.latestBoarding)}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            `}
          </div>
        `;
      }

      const deptGroups = {};
      allReports.forEach(r => {
        const dept = (r.department || '').trim() || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡∏Ç‡∏≤';
        if (!deptGroups[dept]) deptGroups[dept] = [];
        deptGroups[dept].push(r);
      });
      const deptCounts = {};
      Object.entries(deptGroups).forEach(([dept, reps]) => { deptCounts[dept] = countStatuses(reps); });
      if (deptEl) deptEl.innerHTML = renderBreakdownTable(deptCounts, '‡∏™‡∏≤‡∏Ç‡∏≤');

      const yearGroups = {};
      allReports.forEach(r => {
        const y = (r.academic_year || '').trim() || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏µ';
        if (!yearGroups[y]) yearGroups[y] = [];
        yearGroups[y].push(r);
      });
      const yearCounts = {};
      Object.entries(yearGroups).forEach(([y, reps]) => { yearCounts[y] = countStatuses(reps); });
      if (yearEl) yearEl.innerHTML = renderBreakdownTable(yearCounts, '‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤');

      let invalidDateCount = 0;
      let returnBeforeBoardingCount = 0;

      allReports.forEach(r => {
        const bd = safeParseDate(r.boarding_date);
        const rd = safeParseDate(r.return_date);
        if (!bd || !rd) { invalidDateCount++; return; }
        if (rd.getTime() < bd.getTime()) returnBeforeBoardingCount++;
      });

      if (warnEl) {
        warnEl.innerHTML = `
          <h3 class="text-lg font-semibold text-gray-800 mb-4">‚ö†Ô∏è Data Quality / Warnings</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="rounded-lg p-4 border ${returnBeforeBoardingCount > 0 ? 'bg-red-50 border-red-200' : 'bg-gray-50 border-gray-200'}">
              <p class="font-semibold text-gray-800 mb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà return_date &lt; boarding_date</p>
              <p class="text-3xl font-bold ${returnBeforeBoardingCount > 0 ? 'text-red-600' : 'text-gray-700'}">${returnBeforeBoardingCount}</p>
              <p class="text-xs text-gray-500 mt-1">‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</p>
            </div>

            <div class="rounded-lg p-4 border ${invalidDateCount > 0 ? 'bg-yellow-50 border-yellow-200' : 'bg-gray-50 border-gray-200'}">
              <p class="font-semibold text-gray-800 mb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà boarding_date ‡∏´‡∏£‡∏∑‡∏≠ return_date ‡∏ß‡πà‡∏≤‡∏á/invalid</p>
              <p class="text-3xl font-bold ${invalidDateCount > 0 ? 'text-yellow-700' : 'text-gray-700'}">${invalidDateCount}</p>
              <p class="text-xs text-gray-500 mt-1">‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</p>
            </div>
          </div>

          ${(returnBeforeBoardingCount === 0 && invalidDateCount === 0)
            ? `<p class="text-sm text-emerald-700 mt-4">‚úÖ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>`
            : ''
          }
        `;
      }
    }

    // ============================================
    // UTILITIES
    // ============================================
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDateThai(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      if (isNaN(d.getTime())) return '-';
      return d.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    function getStatusColorClass(status) {
      const s = normalizeStatus(status);

      
      if (s === 'ON LEAVE - WAIT FOR GRADUATION PROCESS') return 'bg-fuchsia-100 text-fuchsia-800';

      if (s === 'READY TO JOIN SHIP') return 'bg-yellow-100 text-yellow-800';
      if (s === 'ON BOARD') return 'bg-green-100 text-green-800';

      if (s === 'ON LEAVE - APPLY FOR GRADUATION') return 'bg-purple-100 text-purple-800';
      if (s === 'ON LEAVE - WAIT FOR REJOIN') return 'bg-rose-100 text-rose-800';
      if (s === 'ON LEAVE - OWN BUSINESS') return 'bg-orange-100 text-orange-800';

      if (s === 'THE VOYAGE PROCESS') return 'bg-blue-100 text-blue-800';
      if (s === 'GRADUATED') return 'bg-emerald-100 text-emerald-800';

      return 'bg-gray-100 text-gray-800';
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      if (!container) return;

      const toast = document.createElement('div');
      toast.className = `toast px-6 py-3 rounded-xl shadow-lg flex items-center gap-3 ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        'bg-blue-500 text-white'
      }`;

      const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
      toast.innerHTML = `<span>${icon}</span><span>${escapeHtml(message)}</span>`;

      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
  </script>

  <!-- Edit Report Modal (SHOW ALL FIELDS) -->
  <div id="edit-modal" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeEditModal()"></div>
    <div class="relative min-h-full flex items-center justify-center p-4">
      <div class="glass-card-solid rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto my-4">
        <div class="p-6 border-b border-gray-200 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-t-2xl">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold text-white">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</h2>
            <button onclick="closeEditModal()" class="text-white hover:bg-white/20 rounded-lg p-2 transition-colors">‚úï</button>
          </div>
        </div>

        <form id="edit-form" class="p-6 space-y-5">
          <div class="bg-gray-50 border border-gray-200 rounded-xl p-4">
            <p class="text-sm font-semibold text-gray-800 mb-3">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ / ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á (‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
                <input type="text" id="edit-student-id" readonly
                  class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-white text-gray-700">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                <input type="text" id="edit-student-name" readonly
                  class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-white text-gray-700">
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
                <input type="text" id="edit-academic-year" readonly
                  class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-white text-gray-700">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡∏≤‡∏Ç‡∏≤</label>
                <input type="text" id="edit-department"
                  class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-white text-gray-700">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Trip # (‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏ô‡∏õ‡∏µ)</label>
                <input type="text" id="edit-trip-seq" readonly
                  class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-white text-gray-700">
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Trip ID (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á)</label>
                <input type="text" id="edit-trip-id" readonly
                  class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-white text-gray-700">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Submitted At</label>
                <input type="text" id="edit-submitted-at" readonly
                  class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-white text-gray-700">
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡πÄ‡∏£‡∏∑‡∏≠ <span class="text-red-500">*</span></label>
              <input type="date" id="edit-boarding-date" required
                class="w-full px-4 py-3 rounded-xl border border-gray-300">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏•‡∏±‡∏ö/‡∏•‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏£‡∏∑‡∏≠ <span class="text-red-500">*</span></label>
              <input type="date" id="edit-return-date" required
                class="w-full px-4 py-3 rounded-xl border border-gray-300">
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà JOIN</label>
              <input type="date" id="edit-join-date"
                class="w-full px-4 py-3 rounded-xl border border-gray-300">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà LEAVE</label>
              <input type="date" id="edit-leave-date"
                class="w-full px-4 py-3 rounded-xl border border-gray-300">
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡∏≠</label>
              <input type="text" id="edit-ship-name"
                class="w-full px-4 py-3 rounded-xl border border-gray-300">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÄ‡∏£‡∏∑‡∏≠</label>
              <input type="text" id="edit-company-name"
                class="w-full px-4 py-3 rounded-xl border border-gray-300">
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">‡∏•‡∏á‡∏•‡∏≥‡∏ó‡∏µ‡πà</label>
              <input type="number" id="edit-trip-number" min="1"
                class="w-full px-4 py-3 rounded-xl border border-gray-300">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
              <select id="edit-status" class="w-full px-4 py-3 rounded-xl border border-gray-300">
                <option value="NO REQUEST TO JOIN THE SHIP">üö´ NO REQUEST TO JOIN THE SHIP</option>
                <option value="THE VOYAGE PROCESS">üåä THE VOYAGE PROCESS</option>
                <option value="READY TO JOIN SHIP">‚è≥ READY TO JOIN SHIP</option>
                <option value="ON BOARD">‚úÖ ON BOARD</option>
                <option value="ON LEAVE - APPLY FOR GRADUATION">üéì ON LEAVE - APPLY FOR GRADUATION</option>
                <option value="ON LEAVE - WAIT FOR GRADUATION PROCESS">‚è≥üéì ON LEAVE - WAIT FOR GRADUATION PROCESS</option>
                <option value="ON LEAVE - OWN BUSINESS">üíº ON LEAVE - OWN BUSINESS</option>
                <option value="ON LEAVE - WAIT FOR REJOIN">‚è∏Ô∏è ON LEAVE - WAIT FOR REJOIN</option>
                <option value="GRADUATED">üéâ GRADUATED</option>
              </select>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label>
            <textarea id="edit-work-details" rows="3"
              class="w-full px-4 py-3 rounded-xl border border-gray-300 resize-none"></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
            <textarea id="edit-notes" rows="2"
              class="w-full px-4 py-3 rounded-xl border border-gray-300 resize-none"></textarea>
          </div>

          <div class="flex gap-3 pt-4">
            <button type="button" onclick="closeEditModal()"
              class="flex-1 px-6 py-3 rounded-xl border border-gray-300 text-gray-700 font-medium hover:bg-gray-50">
              ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
            <button type="submit"
              class="flex-1 btn-primary text-white px-6 py-3 rounded-xl font-medium">
              ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Student Modal -->
  <div id="student-modal" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeStudentModal()"></div>
    <div class="relative min-h-full flex items-center justify-center p-4">
      <div class="glass-card-solid rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto my-4">
        <div class="p-6 border-b border-gray-200 bg-gradient-to-r from-emerald-600 to-teal-600 rounded-t-2xl">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold text-white">üë§ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö)</h2>
            <button onclick="closeStudentModal()" class="text-white hover:bg-white/20 rounded-lg p-2 transition-colors">‚úï</button>
          </div>
        </div>

        <div class="p-6 space-y-6">
          <form id="student-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
                <input id="stu-year" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2568" class="w-full px-4 py-3 rounded-xl border border-gray-300" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡∏≤‡∏Ç‡∏≤</label>
                <input id="stu-dept" placeholder="‡πÄ‡∏ä‡πà‡∏ô DECK" class="w-full px-4 py-3 rounded-xl border border-gray-300" required>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
                <input id="stu-id" class="w-full px-4 py-3 rounded-xl border border-gray-300" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                <input id="stu-name" class="w-full px-4 py-3 rounded-xl border border-gray-300" required>
              </div>
            </div>

            <div class="flex gap-3">
              <button type="submit" class="btn-primary text-white px-6 py-3 rounded-xl font-medium">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</button>
            </div>
          </form>

          <div class="border-t pt-4">
            <div class="flex items-center gap-3 mb-3">
              <span class="font-semibold text-gray-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏ô Firestore</span>
              <span class="text-xs text-gray-500">(‡∏•‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏ú‡∏¥‡∏î)</span>
            </div>
            <div id="student-list" class="overflow-x-auto"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ NEW: Export Modal -->
  <div id="export-modal" class="fixed inset-0 z-50 hidden">
    <div class="modal-overlay absolute inset-0" onclick="closeExportModal()"></div>
    <div class="relative min-h-full flex items-center justify-center p-4">
      <div class="glass-card-solid rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">
        <div class="p-5 border-b border-gray-200 bg-gradient-to-r from-amber-500 to-orange-500">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-bold text-white">‚¨áÔ∏è Export</h2>
            <button onclick="closeExportModal()" class="text-white hover:bg-white/20 rounded-lg px-3 py-1">‚úï</button>
          </div>
        </div>

        <div class="p-5 space-y-3">
          <div class="text-sm text-gray-600">
            ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏∞ Export ‚Äú‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á/‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏ì ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‚Äù
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <button onclick="exportReportsCSV()" class="btn-primary text-white px-4 py-3 rounded-xl font-medium">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (CSV)</button>
            <button onclick="exportReportsXLSX()" class="btn-secondary text-white px-4 py-3 rounded-xl font-medium">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (Excel)</button>

            <button onclick="exportStudentsCSV()" class="btn-primary text-white px-4 py-3 rounded-xl font-medium">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (CSV)</button>
            <button onclick="exportStudentsXLSX()" class="btn-secondary text-white px-4 py-3 rounded-xl font-medium">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (Excel)</button>
          </div>

          <div class="pt-2">
            <button onclick="closeExportModal()" class="w-full px-4 py-3 rounded-xl border border-gray-300 text-gray-700 font-medium hover:bg-gray-50">
              ‡∏õ‡∏¥‡∏î
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
